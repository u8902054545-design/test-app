<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        const app = initializeApp(typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "fake", projectId: "p" });
        signInAnonymously(getAuth(app)).catch(()=>console.warn("Auth: Local"));
    </script>

    <style>
        :root {
            --bg: #0b1219; --surface: #161c24; --primary: #0000FF; --text: #E6E1E5;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; }
        
        /* Анимации и спиннер */
        .spinner { animation: rot 2s linear infinite; width: 24px; height: 24px; }
        .path { stroke: #fff; stroke-width: 4; stroke-dasharray: 1,150; animation: dash 1.5s ease-in-out infinite; }
        @keyframes rot { 100% { transform: rotate(360deg); } }
        @keyframes dash { 0% { stroke-dasharray: 1,150; stroke-dashoffset: 0; } 50% { stroke-dasharray: 90,150; stroke-dashoffset: -35; } 100% { stroke-dasharray: 90,150; stroke-dashoffset: -124; } }

        /* Страницы */
        .page { position: fixed; inset: 0; background: var(--bg); transition: transform 0.4s ease, opacity 0.4s; z-index: 10; overflow-y: auto; padding-bottom: 90px; }
        .page-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .page-active { transform: translateX(0); opacity: 1; }
        
        /* Элементы UI */
        .card { background: var(--surface); border-radius: 16px; padding: 16px; transition: 0.2s; border: 1px solid transparent; }
        .card:active { transform: scale(0.98); }
        .card.active { background: #1a2230; border-color: var(--primary); }
        
        /* Кнопка действия (внизу) */
        .action-btn {
            background: var(--primary); color: white; border-radius: 12px; padding: 14px;
            font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; box-shadow: 0 4px 15px rgba(0,0,255,0.3); transition: 0.2s;
        }
        .action-btn:disabled { opacity: 0.7; filter: grayscale(1); }
        .action-btn:active { transform: scale(0.98); }

        /* Окно кода */
        .code-frame {
            background: #000; border: 2px solid #0000FF; border-radius: 16px;
            padding: 16px; position: relative; min-height: 180px; font-family: 'Fira Code', monospace; font-size: 13px; line-height: 1.5;
            white-space: pre-wrap; word-break: break-all;
        }
        /* Подсветка синтаксиса */
        .s-kw { color: #ff7b72; font-weight: bold; } /* def, return */
        .s-fn { color: #79c0ff; } /* func names */
        .s-str { color: #a5d6ff; } /* strings */
        .s-com { color: #8b949e; font-style: italic; } /* comments */
        .s-num { color: #d2a8ff; } /* numbers */

        /* Всплывашки */
        .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-radius: 24px 24px 0 0; transform: translateY(100%); transition: 0.3s; z-index: 50; padding: 24px; border-top: 1px solid #333; }
        .sheet.open { transform: translateY(0); }
        .scrim { position: fixed; inset: 0; background: rgba(0,0,0,0.7); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 40; }
        .scrim.active { opacity: 1; pointer-events: auto; }
        
        /* Таймер чип */
        .chip { border-radius: 8px; padding: 4px 10px; font-size: 12px; font-weight: 600; display: flex; gap: 6px; align-items: center; }
        .t-norm { background: #0f2e45; color: #c2e7ff; }
        .t-warn { background: #633b00; color: #ffdcbe; }
        .t-err { background: #601410; color: #f2b8b5; }
        
        .notification { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 12px; z-index: 100; transition: 0.4s; background: #333; display: flex; gap: 10px; align-items: center; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .notification.show { top: 16px; }
    </style>
</head>
<body>

    <div id="auth-loader" class="fixed inset-0 bg-[#0b1219] z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <svg class="spinner mb-4" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none"></circle></svg>
        <span class="text-xs font-medium tracking-widest uppercase text-gray-400">Loading Config</span>
    </div>

    <div id="notif-box" class="notification border border-white/10">
        <i id="notif-icon" data-lucide="info" class="w-5 h-5 text-blue-400"></i>
        <span id="notif-text" class="text-sm font-medium">Message</span>
    </div>

    <div id="page-list" class="page page-active">
        <header class="sticky top-0 bg-[#0b1219]/95 backdrop-blur z-20 px-4 h-16 flex items-center justify-center border-b border-white/5">
            <h1 class="text-[16px] font-bold text-white">Разработка</h1>
        </header>
        
        <div class="p-4 max-w-md mx-auto space-y-4">
            <div id="active-tasks-wrapper" class="hidden">
                <div id="active-tasks-container" class="space-y-3"></div>
                <div class="h-px bg-white/10 my-6"></div>
            </div>

            <h2 id="task-counter" class="text-2xl font-bold text-gray-200 hidden">Ожидают 0</h2>
            <div id="tasks-container" class="space-y-3 pb-20"></div>

            <div id="empty-state" class="flex flex-col items-center py-12 hidden">
                <i data-lucide="package-search" class="w-12 h-12 text-gray-700 mb-4"></i>
                <p class="text-gray-500 text-sm">Нет новых задач</p>
            </div>
        </div>
    </div>

    <div id="page-assembly" class="page page-hidden flex flex-col">
        <header class="sticky top-0 bg-[#0b1219] z-20 px-4 h-16 flex items-center gap-4 border-b border-white/5">
            <button onclick="closeAssembly()" class="p-2 -ml-2 rounded-full hover:bg-white/5"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h1 class="text-[16px] font-bold text-white">Выполнение разработки</h1>
        </header>

        <div class="flex-1 p-5 max-w-xl mx-auto w-full flex flex-col">
            <div class="flex justify-between items-end mb-2 w-full">
                <div class="bg-blue-600 rounded px-2 py-1 shadow-lg shadow-blue-900/20">
                    <span id="header-task-id" class="text-xs font-mono font-bold text-white tracking-wide">ID: ---</span>
                </div>
                <div id="assembly-timer" class="chip t-norm">
                    <i data-lucide="timer" class="w-3 h-3"></i><span id="assembly-timer-text">--:--</span>
                </div>
            </div>

            <div id="stage-coding" class="w-full flex-1 flex flex-col gap-4">
                <div id="interactive-area" class="opacity-50 pointer-events-none transition-opacity duration-300 w-full relative">
                    <div class="code-frame shadow-lg">
                        <div id="code-spinner" class="absolute inset-0 flex items-center justify-center bg-black/50 z-10"><svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none"></circle></svg></div>
                        <div id="python-code-content" class="relative z-0"></div>
                        <button onclick="copyCode()" class="absolute top-2 right-2 p-1.5 bg-white/10 rounded hover:bg-white/20 text-blue-300 transition"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>
                
                <div id="coding-actions" class="hidden space-y-3 mt-2">
                    <button onclick="openAuthSheet()" class="w-full py-3 text-xs text-blue-300 uppercase font-bold tracking-wider hover:bg-white/5 rounded-lg border border-blue-900/30">Return Input Block</button>
                </div>
            </div>

            <div id="stage-final" class="hidden w-full flex-1 flex flex-col gap-4">
                 <div class="code-frame border-purple-500/50 bg-[#0f0e11]">
                    <span class="text-purple-300"># System Integration</span><br>
                    def push_stream(data):<br>
                    &nbsp;&nbsp;sys.pipe(data)<br><br>
                    blocks = [<span id="final-code-entry" class="text-yellow-300">waiting...</span>]<br>
                    push_stream(blocks)
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <input type="text" id="final-block-1" placeholder="Block ID 1" oninput="updateFinalCode()" class="bg-[#161c24] border border-gray-700 rounded-lg p-3 text-white text-sm outline-none focus:border-blue-500">
                    <input type="text" id="final-block-2" placeholder="Block ID 2" oninput="updateFinalCode()" class="bg-[#161c24] border border-gray-700 rounded-lg p-3 text-white text-sm outline-none focus:border-blue-500">
                </div>
                <button onclick="reopenConfigTable()" class="text-xs text-gray-400 underline text-center py-2">Открыть таблицу кодов</button>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#0b1219] via-[#0b1219] to-transparent z-30">
            <div class="max-w-xl mx-auto">
                <button id="main-action-btn" class="action-btn" onclick="handleMainAction()">
                    Начать выполнение
                </button>
            </div>
        </div>
    </div>

    <div id="scrim-main" class="scrim" onclick="closeAllSheets()"></div>
    
    <div id="sheet-auth" class="sheet">
        <h3 class="text-lg font-bold mb-4">Токен доступа</h3>
        <input type="text" id="token-input" class="w-full bg-[#0b1219] border border-gray-600 rounded-lg p-3 text-white mb-4" placeholder="Введите токен">
        <button onclick="authorizeCode()" class="action-btn">Авторизовать</button>
    </div>

    <div id="sheet-table" class="sheet !h-[70vh] flex flex-col">
        <h3 class="text-lg font-bold mb-4">Конфигурация</h3>
        <div class="flex-1 overflow-auto bg-[#1e1e1e] rounded border border-gray-700 p-1 mb-4">
            <table class="w-full text-xs text-left text-gray-300">
                <thead class="bg-[#2d2d2d] text-gray-400"><tr><th class="p-2">Auth</th><th class="p-2">Name</th><th class="p-2">Code</th></tr></thead>
                <tbody id="table-body" class="divide-y divide-gray-700"></tbody>
            </table>
        </div>
        <button onclick="handleTableClose()" class="action-btn !bg-[#161c24] border border-blue-500 text-blue-400">Подтвердить</button>
    </div>

    <script>
        // Config & Utils
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYIThLvfF1N6s2PhzvqvI5Q7YP_XWARDGVF80sjDyjAbUX34WeSazYBooafEBN2--Y/exec';
        const AUTH_URL = "https://u8902054545-design.github.io/Auth-ITC-Platform/";
        
        let poolTasks = [], userTasks = [], activeTaskId = null, currentStage = 'START'; // START, ASSEMBLY, FINAL

        const $ = id => document.getElementById(id);
        const formatTime = s => {
            const m = Math.floor(Math.abs(s)/60), sc = Math.abs(s)%60;
            return (s<0?'+':'') + `${m}`.padStart(2,'0') + ':' + `${sc}`.padStart(2,'0');
        };

        // Syntax Highlighter (GAS Style)
        function colorizePython(code) {
            if(!code) return '';
            return code
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/#.*/g, '<span class="s-com">$&</span>')
                .replace(/"(.*?)"/g, '<span class="s-str">"$1"</span>')
                .replace(/\b(def|return|if|else|elif|for|while|import|from|class|try|except)\b/g, '<span class="s-kw">$1</span>')
                .replace(/\b(print|len|range|str|int|float|list)\b/g, '<span class="s-fn">$1</span>')
                .replace(/\b\d+\b/g, '<span class="s-num">$&</span>');
        }

        // Logic
        async function checkAuth() {
            const email = localStorage.getItem('userEmail'), token = localStorage.getItem('authToken');
            if (!email || !token) return window.location.href = AUTH_URL;
            try {
                const r = await fetch(`${SCRIPT_URL}?action=checkAuth&email=${email}&token=${token}`);
                const d = await r.json();
                if (!d.authorized) throw new Error();
                $('auth-loader').classList.add('opacity-0');
                setTimeout(()=>$('auth-loader').remove(),500);
                initLoop();
            } catch { window.location.href = AUTH_URL; }
        }

        async function updateData() {
            try {
                const [r1, r2] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getTasks`).then(r=>r.json()),
                    fetch(`${SCRIPT_URL}?action=getUserActiveTasks&email=${localStorage.getItem('userEmail')}`).then(r=>r.json())
                ]);
                
                // Update Pool
                poolTasks = r1;
                const poolHTML = poolTasks.map(t => makeCardHTML(t, false)).join('');
                $('tasks-container').innerHTML = poolHTML;
                $('task-counter').textContent = `Ожидают ${poolTasks.length}`;
                $('task-counter').classList.toggle('hidden', poolTasks.length===0);
                $('empty-state').classList.toggle('hidden', poolTasks.length > 0 || r2.length > 0);

                // Update Active
                userTasks = r2;
                $('active-tasks-container').innerHTML = userTasks.map(t => makeCardHTML(t, true)).join('');
                $('active-tasks-wrapper').classList.toggle('hidden', userTasks.length===0);
                
                lucide.createIcons();
            } catch(e) { console.error(e); }
        }

        function makeCardHTML(t, active) {
            return `
            <div class="card ${active?'active':''}" onclick="${active ? `restore('${t.id}', '${t.stage}')` : `openTask('${t.id}')`}">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-[10px] font-bold uppercase tracking-wider ${active?'text-blue-400':'text-gray-500'}">${active?'В работе':'Задача'}</div>
                        <div class="text-sm font-medium text-white break-all">${t.id}</div>
                    </div>
                    <div class="chip t-norm timer-ref" data-time="${t.durationSeconds}"><i data-lucide="timer" class="w-3 h-3"></i><span>${formatTime(t.durationSeconds)}</span></div>
                </div>
            </div>`;
        }

        // Timers
        setInterval(() => {
            document.querySelectorAll('.timer-ref').forEach(el => {
                let s = parseInt(el.dataset.time) - 1;
                el.dataset.time = s;
                const sp = el.querySelector('span');
                if(sp) sp.textContent = formatTime(s);
                el.className = `chip timer-ref ${s<0 ? 't-err' : (s<60 ? 't-warn' : 't-norm')}`;
                
                // Update active header timer
                if(activeTaskId && el.closest('.card') && el.closest('.card').onclick.toString().includes(activeTaskId)) {
                   $('assembly-timer').className = el.className.replace('timer-ref','');
                   $('assembly-timer-text').textContent = formatTime(s);
                }
            });
        }, 1000);

        // Navigation & State
        function openTask(id) {
            setupStage(id, 'START');
        }

        function restore(id, stage) {
            setupStage(id, stage || 'ASSEMBLY');
            loadCode();
        }

        function setupStage(id, stage) {
            activeTaskId = id;
            currentStage = stage;
            $('header-task-id').textContent = `ID: ${id}`;
            $('page-list').classList.add('page-hidden');
            $('page-list').classList.remove('page-active');
            $('page-assembly').classList.remove('page-hidden');
            $('page-assembly').classList.add('page-active');

            const btn = $('main-action-btn');
            const overlay = $('interactive-area');
            
            // Reset UI
            $('python-code-content').innerHTML = '';
            $('code-spinner').classList.remove('hidden');
            $('final-block-1').value = ''; $('final-block-2').value = '';
            
            if (stage === 'START') {
                $('stage-coding').classList.remove('hidden');
                $('stage-final').classList.add('hidden');
                $('coding-actions').classList.add('hidden');
                overlay.classList.add('opacity-50', 'pointer-events-none');
                btn.textContent = "Начать выполнение";
                btn.onclick = startAssembly;
                btn.classList.remove('hidden');
            } else if (stage === 'ASSEMBLY') {
                $('stage-coding').classList.remove('hidden');
                $('stage-final').classList.add('hidden');
                $('coding-actions').classList.remove('hidden');
                overlay.classList.remove('opacity-50', 'pointer-events-none');
                btn.classList.add('hidden'); // Кнопка скрыта во время работы, нужна логика возврата? В ТЗ кнопка внизу.
                // В коде оригинала кнопка "Start" исчезала. Тут оставим, но переназначим если нужно.
                // Для упрощения: кнопка внизу будет "Завершить", но она активна только на финальном этапе?
                // По ТЗ: "Завершить выполнение, на том же месте". Значит меняем текст.
                btn.classList.remove('hidden');
                btn.textContent = "В процессе...";
                btn.disabled = true;
            } else if (stage === 'FINAL') {
                $('stage-coding').classList.add('hidden');
                $('stage-final').classList.remove('hidden');
                btn.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = "Завершить выполнение";
                btn.onclick = finishTask;
            }
            lucide.createIcons();
        }

        async function loadCode() {
            try {
                const r = await fetch(`${SCRIPT_URL}?action=getPythonCode`);
                const d = await r.json();
                $('code-spinner').classList.add('hidden');
                $('python-code-content').innerHTML = colorizePython(d.code || "# No code");
            } catch {
                $('python-code-content').innerHTML = "# Error loading code";
            }
        }

        // Actions
        async function startAssembly() {
            const btn = $('main-action-btn');
            btn.innerHTML = '<svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none"/></svg>';
            try {
                await loadCode();
                await fetch(`${SCRIPT_URL}?action=startTask&email=${localStorage.getItem('userEmail')}&taskId=${activeTaskId}`);
                currentStage = 'ASSEMBLY';
                $('interactive-area').classList.remove('opacity-50', 'pointer-events-none');
                $('coding-actions').classList.remove('hidden');
                btn.textContent = "В процессе...";
                btn.disabled = true;
                updateData();
            } catch { alert('Ошибка старта'); closeAssembly(); }
        }

        function handleMainAction() {
            if(currentStage === 'START') startAssembly();
            else if(currentStage === 'FINAL') finishTask();
        }

        function openAuthSheet() { 
            $('scrim-main').classList.add('active'); 
            $('sheet-auth').classList.add('open'); 
        }

        function authorizeCode() {
            if(!$('token-input').value) return;
            $('sheet-auth').classList.remove('open');
            notify('Код авторизован', 'success');
            setTimeout(()=>{
                fillTable();
                $('sheet-table').classList.add('open');
            }, 800);
        }

        function fillTable() {
            const b = $('table-body'); b.innerHTML = '';
            for(let i=0; i<3; i++) {
                b.innerHTML += `<tr><td class="p-2">${Math.floor(Math.random()*9000)}</td><td class="p-2">${Math.random().toString(36).substr(2,5)}</td><td class="p-2 font-mono text-blue-300">sys.block(${i})</td></tr>`;
            }
        }

        function handleTableClose() {
            closeAllSheets();
            currentStage = 'FINAL';
            $('stage-coding').classList.add('hidden');
            $('stage-final').classList.remove('hidden');
            
            const btn = $('main-action-btn');
            btn.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = "Завершить выполнение";
            btn.onclick = finishTask;
            
            fetch(`${SCRIPT_URL}?action=updateStage&email=${localStorage.getItem('userEmail')}&taskId=${activeTaskId}&stage=FINAL`);
        }

        function updateFinalCode() {
            $('final-code-entry').textContent = `"${$('final-block-1').value}", "${$('final-block-2').value}"`;
        }

        async function finishTask() {
            if(!$('final-block-1').value || !$('final-block-2').value) return notify('Заполните блоки ID', 'error');
            
            const btn = $('main-action-btn');
            btn.innerHTML = '<svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none"/></svg>';
            
            try {
                const r = await fetch(`${SCRIPT_URL}?action=completeTask&email=${localStorage.getItem('userEmail')}&taskId=${activeTaskId}&block1=${$('final-block-1').value}&block2=${$('final-block-2').value}`);
                const d = await r.json();
                if(d.status === 'Success') {
                    notify('Задача выполнена!', 'success');
                    closeAssembly();
                } else throw new Error();
            } catch {
                btn.textContent = "Ошибка";
                setTimeout(()=> btn.textContent = "Завершить выполнение", 2000);
            }
        }

        // Utils UI
        function closeAssembly() {
            $('page-assembly').classList.add('page-hidden');
            $('page-assembly').classList.remove('page-active');
            $('page-list').classList.remove('page-hidden');
            $('page-list').classList.add('page-active');
            activeTaskId = null;
            closeAllSheets();
            updateData();
        }
        
        function closeAllSheets() {
            $('scrim-main').classList.remove('active');
            document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
        }
        
        function copyCode() {
             const txt = $('python-code-content').innerText;
             navigator.clipboard.writeText(txt);
             notify('Код скопирован');
        }

        function notify(msg, type) {
            $('notif-text').textContent = msg;
            const box = $('notif-box');
            box.style.background = type==='error'?'#601410' : (type==='success'?'#0f2e45':'#333');
            box.classList.add('show');
            setTimeout(()=>box.classList.remove('show'), 3000);
        }

        function reopenConfigTable() { $('scrim-main').classList.add('active'); $('sheet-table').classList.add('open'); }
        function initLoop() { updateData(); setInterval(updateData, 4000); }

        window.onload = checkAuth;
    </script>
</body>
    </html>
