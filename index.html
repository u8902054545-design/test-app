<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Авторизация ITC Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Basic Styles and Reset --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #000000;
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            box-sizing: border-box;
            overflow-x: hidden;
            overflow-y: hidden; /* Блокируем скролл body, чтобы скроллил только iframe */
        }

        /* --- Defining CSS variables for colors --- */
        :root {
            --color-blue: #0000FF;
            --color-purple: #0000FF; 
            --color-red: #ff0000;
            --animation-duration: 3s;
            --transition-duration: 0.5s; /* Длительность анимации перехода */
        }
        
        /* ---------------------------------------------------- */
        /* --- НОВАЯ АНИМАЦИЯ ЗАГРУЗКИ (Google Play Style) --- */
        /* ---------------------------------------------------- */

        #overlay-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Полупрозрачный фон, чтобы соответствовал оверлею */
            background-color: rgba(0, 0, 0, 0.7); 
            display: none; /* Изначально скрыт, будет управляться JS (для показа при AJAX) */
            justify-content: center;
            align-items: center;
            z-index: 200; /* Максимальный Z-index, выше всего */
            /* Добавлено для плавного появления/скрытия */
            transition: opacity var(--transition-duration) ease, visibility var(--transition-duration) ease;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        /* Класс, который JS будет добавлять для отображения */
        #overlay-loading.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            display: flex; /* Обеспечиваем отображение во время анимации */
        }
        
        /* --- Стили Спиннера (SVG) --- */
        .spinner {
            width: 60px; 
            height: 60px;
            /* Анимация вращения всего спиннера */
            animation: rotate 2s linear infinite; 
            transform-origin: center center;
        }

        .path {
            /* Фиксированный цвет спиннера: #0000FF */
            stroke: var(--color-blue); 
            stroke-linecap: round;
            stroke-width: 4; /* СРЕДНЯЯ ТОЛЩИНА ЛИНИИ (4px) */
            
            /* Базовые значения dasharray для современного эффекта */
            stroke-dasharray: 1, 150; 
            
            /* Анимация хода - изменяет длину и положение арки (современный эффект) */
            animation: dash 1.5s ease-in-out infinite; 
        }

        /* Ключевые кадры для вращения всего спиннера */
        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Ключевые кадры для изменения длины и смещения штриха (Современный "бегущий" эффект) */
        @keyframes dash {
            0% {
                stroke-dasharray: 1, 150;
                stroke-dashoffset: 0;
            }
            50% {
                /* Дуга достигает максимальной длины */
                stroke-dasharray: 70, 150; 
                stroke-dashoffset: -25px;
            }
            100% {
                /* Дуга "сжимается" и быстро смещается */
                stroke-dasharray: 70, 150;
                stroke-dashoffset: -125px;
            }
        }
        
        /* ---------------------------------------------------- */
        /* --- Анимации перехода страниц --- */
        /* ---------------------------------------------------- */
        
        /* Стиль для скрытия контейнера авторизации до начала анимации */
        #authFormContainer.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* --- Authorization form styles (Page 1) --- */
        #authFormContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #000000;
            color: white;
            font-family: sans-serif;
            box-sizing: border-box;
            width: 100%;
            position: fixed; 
            top: 0;
            left: 0; 
            bottom: 0;
            z-index: 99; 
            transform: translateX(0); 
            /* Добавляем transition для opacity, чтобы использовать его в начальной анимации */
            transition: transform var(--transition-duration) ease-in-out, opacity var(--transition-duration) ease-in-out; 
        }
        
        #authFormContainer.slide-out {
            transform: translateX(-100%); 
        }
        
        /* --- Verification Code Page styles (Page 2) --- */
        #codeVerificationContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #000000;
            color: white;
            font-family: sans-serif;
            box-sizing: border-box;
            width: 100%;
            position: fixed; 
            top: 0;
            left: 0; 
            bottom: 0;
            z-index: 98; 
            transform: translateX(100%); 
            transition: transform var(--transition-duration) ease-in-out; 
        }
        
        #codeVerificationContainer.slide-in {
            transform: translateX(0); 
        }

        /* --- Общие стили для контента внутри страниц */
        .page-content {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 5px 15px 150px; 
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            height: 100%; 
        }
        
        /* ---------------------------------------------------- */
        /* --- Остальные стили (с исправлениями) --- */
        /* ---------------------------------------------------- */
        
        /* Общие стили для заголовков и подзаголовков */
        .darkcenter-title {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
            margin-top: 10px;
            background-image: linear-gradient(to right, #0000FF, #0000FF, #ff0000, #0000FF, #0000FF);
            background-size: 400% 100%;
            animation: gradientFlow-new 4s linear infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        @keyframes gradientFlow-new {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .login-title {
            font-weight: bold;
            font-size: 22px;
            margin-top: 0;
            margin-bottom: 10px; 
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            padding: 0 1px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #AAAAAA;
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            padding: 0 1px;
            line-height: 1.4;
        }
        
        /* Стили для поля ввода email (только для Page 1) */
        .input-group {
            position: relative;
            box-sizing: border-box;
            width: 100%;
            margin-bottom: 15px;
            padding: 0 1px;
        }

        .input-group .input-field {
            width: 100%;
            padding: 24px 11px 8px;
            height: 56px;
            background-color: #000000;
            border: 1px solid #615f5f;
            border-radius: 12px;
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s ease;
            font-size: 16px;
            caret-color: var(--color-blue); 
        }

        .input-group .input-label {
            position: absolute;
            top: 50%;
            left: 13px;
            transform: translateY(-50%);
            color: #615f5f;
            pointer-events: none;
            transition: top 0.3s ease, left 0.3s ease, transform 0.3s ease, font-size 0.3s ease, color 0.3s ease, padding 0.3s ease;
            font-size: 16px;
        }

        .input-group .input-field:focus {
            border: 2px solid #0000FF;
        }

        .input-group .input-field:focus + .input-label {
             color: #0000FF;
        }

        .input-group .input-field:focus + .input-label,
        .input-group .input-field:not(:placeholder-shown) + .input-label {
            top: 0;
            left: 10px;
            transform: translateY(-50%) scale(0.75);
            background-color: #000000;
            padding: 0 4px;
        }

        .input-group .input-field:not(:focus):placeholder-shown {
            border-color: #615f5f;
        }

        .input-group .input-field:disabled {
            background-color: #2c2c2c;
            color: #888;
            cursor: not-allowed;
            border-color: #444;
        }

        .error-message {
            color: #FF7F7F;
            font-size: 12px;
            margin-top: 5px;
            text-align: left;
            display: none;
            width: 100%;
        }

        .error-border {
            border-color: #FF7F7F !important;
        }

        /* --- Code Input Grid Styles (Page 2) --- */
        .code-input-grid {
            display: flex;
            justify-content: space-between;
            gap: 8px; 
            width: 100%;
            max-width: 350px; 
            margin-bottom: 25px;
            box-sizing: border-box;
            padding: 0 1px;
        }

        .code-input-grid .code-box {
            width: 45px;
            height: 45px;
            font-size: 24px;
            text-align: center;
            background-color: #1a1a1a;
            border: 2px solid #615f5f;
            border-radius: 8px;
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            caret-color: var(--color-blue); 
        }
        
        .code-input-grid .code-box:focus {
            border-color: var(--color-blue);
            box-shadow: 0 0 5px var(--color-blue);
        }
        
        .code-input-grid .code-box:disabled { 
            background-color: #0a0a0a;
            color: #444;
            border-color: #2c2c2c;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* --- Fixed Button Container Styles --- */
        .fixed-button-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000000;
            padding: 10px 15px;
            box-sizing: border-box;
            z-index: 10;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 430px) {
            .fixed-button-container {
                max-width: none;
                left: 0;
                transform: none;
            }
        }
        
        /* --- General Button Styles --- */
        .action-button {
            width: 100%;
            padding: 12px; 
            border: none;
            border-radius: 6px; 
            box-sizing: border-box;
            font-size: 16px;
            margin-bottom: 10px; 
        }
        
        #get-code-button {
            background-color: rgba(0, 0, 255, 0.5);
            color: rgba(255, 255, 255, 0.7);
            cursor: not-allowed;
            transition: background-color 0.1s ease, color 0.1s ease;
        }

        #get-code-button.active {
            background-color: #0000FF;
            color: white;
            cursor: pointer;
        }

        #get-code-button.active:disabled {
             background-color: rgba(0, 0, 255, 0.5);
             cursor: not-allowed;
             color: rgba(255, 255, 255, 0.7);
        }

        #get-code-button.active:not(:disabled):active {
            background-color: #0000CC;
        }
        
        #change-gmail-button {
            background-color: var(--color-blue);
            color: white;
            cursor: pointer;
            font-weight: 600;
        }
        
        #change-gmail-button:active {
            background-color: #0000CC;
        }

        #resend-code-button {
            background-color: transparent;
            color: var(--color-blue);
            border: 1px solid var(--color-blue);
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        #resend-code-button:disabled {
            border-color: rgba(0, 0, 255, 0.5);
            color: rgba(0, 0, 255, 0.5);
            cursor: not-allowed;
        }
        
        #resend-code-button:not(:disabled):active {
            opacity: 0.8;
        }
        
        .code-page-buttons {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
        }

        .footer-text {
            font-size: 12px;
            color: #888;
            text-align: center;
            width: 100%;
            margin-top: 5px; 
            padding: 0 5px;
            line-height: 1.3;
        }
        
        .footer-text a {
            color: var(--color-blue); 
            text-decoration: none; 
            pointer-events: none; 
            position: relative; 
        }
        
        .footer-text a::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto; 
            z-index: 1; 
            opacity: 0;
            background-color: transparent;
        }
        
        .app-version {
            font-size: 10px; 
            color: #555;
            text-align: center;
            width: 100%;
            margin-top: 5px; 
            margin-bottom: 5px; 
        }

        /* ---------------------------------------------------- */
        /* --- СТИЛИ ДЛЯ IFRAME APP CONTAINER (НОВОЕ) --- */
        /* ---------------------------------------------------- */
        #app-iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100; /* Выше форм (99), но ниже спиннера (200) */
            background-color: #000000; /* Фон черный, чтобы избежать белых вспышек */
            display: none; /* Скрыт по умолчанию */
        }

        #app-content-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
    </style>
</head>
<body>

    <!-- Спиннер загрузки -->
    <div id="overlay-loading">
        <svg class="spinner" viewBox="25 25 50 50" role="status" aria-label="Загрузка">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10" />
        </svg>
    </div>

    <!-- НОВОЕ: Контейнер для целевого сайта (Iframe) -->
    <div id="app-iframe-container">
        <iframe id="app-content-frame" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-top-navigation-by-user-activation"></iframe>
    </div>

    <!-- Страница ввода Email -->
    <div id="authFormContainer" class="hidden"> 
        <div class="page-content" id="content-auth"> <div class="darkcenter-title">ITC Platform</div>
            <div class="login-title">Введи свой Gmail</div> 
            <div class="login-subtitle">На твой Gmail будет отправлен код для входа, или совершён звонок по Google Meet, чтобы продиктовать код</div>

            <div class="input-group">
                <input type="email" id="email-input" class="input-field" placeholder=" ">
                <label for="email-input" class="input-label">Gmail</label>
                <div id="email-error" class="error-message"></div>
            </div>
        </div>

        <div class="fixed-button-container">
            <button id="get-code-button" class="action-button" disabled>Получить код</button> 
            <div class="footer-text">
                Продолжая, ты соглашаешься с 
                <a id="privacy-policy-link" href="https://script.google.com/" target="_blank">
                    политикой конфиденциальности
                </a> 
                и 
                <a id="terms-of-service-link" href="https://script.google.com/" target="_blank">
                    условиями сервиса
                </a>
            </div>
            <div class="app-version">
                DarkCenter Google Release, v2.5.8
            </div>
        </div>
    </div>
    
    <!-- Страница ввода Кода -->
    <div id="codeVerificationContainer">
        <div class="page-content" id="content-code"> <div class="darkcenter-title">ITC Platform</div>
            <div class="login-title">Введи код подтверждения из Gmail</div> 
            <div class="login-subtitle">Отправили его на <span id="verification-email"></span></div> 

            <div class="code-input-grid">
                <input type="text" maxlength="1" class="code-box" id="code-input-1" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-2" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-3" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-4" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-5" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-6" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div id="code-error" class="error-message" style="margin-top: -15px; margin-bottom: 25px;"></div>
        </div>

        <div class="fixed-button-container">
            <div class="code-page-buttons">
                <button id="change-gmail-button" class="action-button">Изменить Gmail</button> 
                <button id="resend-code-button" class="action-button" disabled>Получить новый код — через <span id="resend-timer">25 с</span></button>
            </div>
        </div>
    </div>

    <script>
        const authFormContainer = document.getElementById('authFormContainer');
        const codeVerificationContainer = document.getElementById('codeVerificationContainer');
        const overlayLoading = document.getElementById('overlay-loading');
        
        // НОВЫЕ ЭЛЕМЕНТЫ DOM
        const appIframeContainer = document.getElementById('app-iframe-container');
        const appContentFrame = document.getElementById('app-content-frame');

        const emailInput = document.getElementById("email-input");
        const getCodeButton = document.getElementById("get-code-button");
        const emailError = document.getElementById("email-error");
        const verificationEmailSpan = document.getElementById("verification-email");
        const changeGmailButton = document.getElementById("change-gmail-button");
        const resendCodeButton = document.getElementById("resend-code-button");
        const resendTimerSpan = document.getElementById("resend-timer");
        const codeBoxes = [
            document.getElementById('code-input-1'),
            document.getElementById('code-input-2'),
            document.getElementById('code-input-3'),
            document.getElementById('code-input-4'),
            document.getElementById('code-input-5'),
            document.getElementById('code-input-6')
        ];
        const codeError = document.getElementById("code-error");

        // --- КОНСТАНТЫ ДЛЯ СЕССИИ И СЕРВЕРА ---
        const isLoggedInKey = 'isLoggedIn';
        const userLinkKey = 'userLink';
        const sessionExpiresKey = 'sessionExpires';
        const userEmailKey = 'userEmail';
        const authTokenKey = 'authToken'; 
        
        // !!! ВАШ АКТУАЛЬНЫЙ URL GOOGLE APPS SCRIPT !!!
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz0uenNIXAbEI1ZqBLhTK06omyIMa3JquZ5Dil08MrY_jLsRCCff3W1PKQ6XgPM84td/exec"; 
        
        const inactiveUserRedirectLink = "https://app.botpapa.me/@Smena_DarkCenter_bot/smena"; 
        
        let currentEmail = "";
        let lastCodeRequestEmail = "";
        let codeRequestTimestamp = 0;
        const RESEND_TIME = 25; 
        let countdownInterval; 
        
        const BLOCKED_MESSAGES = [
            "Пользователь с таким Gmail не найден",
            "Твой аккаунт DarkCenter заблокирован"
        ];
        
        const CONNECTION_ERROR_TEXT = "Не удалось подключиться к серверу. Проверь подключение к интернету и повтори попытку";
        const REQUIRED_ANDROID_VERSION = 14;
        const VERSION_ERROR_MESSAGE = "Версия Android твоего устройства, не поддерживается";

        // --- НОВАЯ ФУНКЦИЯ: ПЛАВНЫЙ ПЕРЕХОД В IFRAME ---
        /**
         * Загружает целевую ссылку в iframe в фоновом режиме, отображая спиннер.
         * Показывает iframe только после полной загрузки (событие onload).
         */
        function transitionToApp(targetUrl) {
            console.log("Начинаем плавный переход к:", targetUrl);
            
            // 1. Убеждаемся, что спиннер показан (он должен крутиться)
            toggleLoadingOverlay(true);

            // 2. Устанавливаем источник iframe
            // Это начнет загрузку страницы внутри скрытого фрейма
            appContentFrame.src = targetUrl;

            // 3. Вешаем обработчик события полной загрузки
            appContentFrame.onload = function() {
                console.log("Страница в Iframe загружена.");
                
                // Небольшая задержка для уверенности (рендеринг браузера)
                setTimeout(() => {
                    // 4. Скрываем все формы авторизации
                    authFormContainer.style.display = 'none';
                    codeVerificationContainer.style.display = 'none';

                    // 5. Показываем контейнер с iframe
                    appIframeContainer.style.display = 'block';

                    // 6. Плавно убираем спиннер (у нас уже есть transition в CSS)
                    toggleLoadingOverlay(false);
                }, 500); 
            };

            // Дополнительная защита: если onload не сработает долго (например, 15 сек), показать принудительно
            setTimeout(() => {
                if (appIframeContainer.style.display === 'none') {
                    console.log("Превышено время ожидания загрузки, показываем принудительно.");
                    authFormContainer.style.display = 'none';
                    codeVerificationContainer.style.display = 'none';
                    appIframeContainer.style.display = 'block';
                    toggleLoadingOverlay(false);
                }
            }, 15000);
        }
        // --- КОНЕЦ НОВОЙ ФУНКЦИИ ---

        function checkAndroidVersion(locationId) {
            if (!window.Telegram || !window.Telegram.WebApp) {
                return false; 
            }
            const platform = window.Telegram.WebApp.platform;
            if (platform !== 'android') {
                return false; 
            }
            const userAgent = window.navigator.userAgent;
            let androidVersion = 0;
            const match = userAgent.match(/Android\s+([0-9\.]+)/);
            if (match && match[1]) {
                androidVersion = parseInt(match[1].split('.')[0], 10);
            }
            
            if (androidVersion === 0 || androidVersion < REQUIRED_ANDROID_VERSION) {
                const errorElement = locationId === 'auth' ? emailError : codeError;
                
                if (locationId === 'auth' && !authFormContainer.classList.contains('slide-out')) {
                    errorElement.textContent = VERSION_ERROR_MESSAGE;
                    errorElement.style.display = "block";
                    if (locationId === 'auth') {
                        emailInput.classList.add("error-border");
                        getCodeButton.classList.remove("active");
                        getCodeButton.disabled = true;
                    }
                } else if (locationId === 'code' && codeVerificationContainer.classList.contains('slide-in')) {
                    errorElement.textContent = VERSION_ERROR_MESSAGE;
                    errorElement.style.display = "block";
                    lockVerificationControls();
                } else {
                    window.Telegram.WebApp.showAlert(VERSION_ERROR_MESSAGE);
                }
                toggleLoadingOverlay(false);
                return true;
            }
            return false;
        }

        function clearLocalStorageSession() {
            localStorage.removeItem(isLoggedInKey);
            localStorage.removeItem(userLinkKey);
            localStorage.removeItem(sessionExpiresKey);
            localStorage.removeItem(userEmailKey);
            localStorage.removeItem(authTokenKey); 
        }

        function toggleLoadingOverlay(show) {
            if (show) {
                overlayLoading.style.display = 'flex'; 
                setTimeout(() => {
                    overlayLoading.classList.add('visible');
                }, 10);
            } else {
                overlayLoading.classList.remove('visible');
                setTimeout(() => {
                    if (!overlayLoading.classList.contains('visible')) {
                        overlayLoading.style.display = 'none';
                    }
                }, 500); 
            }
        }

        function isValidEmail(email) {
            const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
            return gmailRegex.test(email);
        }
        
        function startResendCountdown(initialTime = RESEND_TIME) {
            clearInterval(countdownInterval); 
            
            let timeLeft = initialTime;
            resendCodeButton.disabled = true;
            resendTimerSpan.textContent = `${timeLeft} с`;
            resendCodeButton.textContent = `Получить новый код — через ${timeLeft} с`; 
            resendCodeButton.classList.remove('blocked'); 
            codeBoxes.forEach(box => box.disabled = false); 
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    
                    if (!resendCodeButton.classList.contains('blocked')) { 
                        resendCodeButton.disabled = false;
                        resendCodeButton.textContent = "Получить новый код";
                        codeRequestTimestamp = 0; 
                        lastCodeRequestEmail = ""; 
                    } else {
                        resendCodeButton.disabled = true;
                        resendCodeButton.textContent = "Получить новый код";
                    }
                } else {
                    resendTimerSpan.textContent = `${timeLeft} с`;
                    resendCodeButton.textContent = `Получить новый код — через ${timeLeft} с`;
                }
            }, 1000);
        }
        
        function lockVerificationControls() {
            clearInterval(countdownInterval); 
            resendCodeButton.disabled = true;
            resendCodeButton.classList.add('blocked');
            resendCodeButton.textContent = "Получить новый код"; 
            codeBoxes.forEach(box => {
                box.value = '';
                box.disabled = true;
                box.classList.remove('error-border');
            });
            codeRequestTimestamp = 0; 
            lastCodeRequestEmail = "";
        }
        
        function setupCodeInput() {
            codeBoxes.forEach((box, index) => {
                box.value = ''; 
                box.disabled = false; 
                box.removeEventListener('input', handleCodeInput); 
                box.removeEventListener('keydown', handleCodeKeydown); 

                function handleCodeInput(event) {
                    const value = event.target.value;
                    codeError.style.display = "none";
                    codeBoxes.forEach(b => b.classList.remove('error-border'));
                    if (/\D/.test(value)) {
                        event.target.value = '';
                        return;
                    }
                    if (value.length === 1 && index < codeBoxes.length - 1) {
                        codeBoxes[index + 1].focus();
                    }
                    if (index === codeBoxes.length - 1 && value.length === 1) {
                        event.target.blur(); 
                        checkCode();
                    }
                }

                function handleCodeKeydown(event) {
                    if (event.key === 'Backspace' && event.target.value === '' && index > 0) {
                        codeBoxes[index - 1].focus();
                    }
                }

                box.addEventListener('input', handleCodeInput);
                box.addEventListener('keydown', handleCodeKeydown);
            });
        }
        
        // --- ФУНКЦИЯ ПРОВЕРКИ ТОКЕНА (ИЗМЕНЕНА) ---
        async function verifyStoredToken(email, token) {
            toggleLoadingOverlay(true);
            console.log("Проверка токена при загрузке...");
            
            try {
                const formData = new URLSearchParams();
                formData.append('email', email);
                formData.append('auth_token', token);
                formData.append('check_token', 'true'); 
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                
                if (data.success) {
                    // ✅ УСПЕХ: ВМЕСТО РЕДИРЕКТА ВЫЗЫВАЕМ ПЛАВНЫЙ ПЕРЕХОД
                    console.log("Авторизация по токену успешна. Загружаем iframe.");
                    transitionToApp(data.redirect_link); // <-- ИЗМЕНЕНИЕ ЗДЕСЬ
                    return true;
                } else {
                    console.warn(`Ошибка токена: ${data.message || 'Неизвестная ошибка'}. Сброс сессии.`);
                    clearLocalStorageSession();
                    toggleLoadingOverlay(false);
                    return false;
                }
                
            } catch (error) {
                console.error("Критическая ошибка при проверке токена:", error);
                clearLocalStorageSession(); 
                toggleLoadingOverlay(false);
                return false;
            }
        }

        // --- ЛОГИКА ПРОВЕРКИ КОДА (ИЗМЕНЕНА) ---
        async function checkCode() {
            if (checkAndroidVersion('code')) {
                return; 
            }

            const code = codeBoxes.map(box => box.value).join('');
            
            if (code.length < 6) return; 
            
            toggleLoadingOverlay(true);
            
            try {
                const formData = new URLSearchParams();
                formData.append('email', currentEmail);
                formData.append('code', code); 
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                
                if (data.success) {
                    // ✅ УСПЕХ: ВМЕСТО РЕДИРЕКТА ВЫЗЫВАЕМ ПЛАВНЫЙ ПЕРЕХОД
                    clearInterval(countdownInterval); 
                    
                    const sessionDurationHours = data.token_expiry_hours || 24; 
                    const sessionDurationMs = sessionDurationHours * 60 * 60 * 1000;
                    const expirationTime = new Date().getTime() + sessionDurationMs;
                    
                    localStorage.setItem(isLoggedInKey, 'true');
                    localStorage.setItem(userLinkKey, data.redirect_link); 
                    localStorage.setItem(sessionExpiresKey, expirationTime.toString());
                    localStorage.setItem(userEmailKey, currentEmail);
                    localStorage.setItem(authTokenKey, data.auth_token); 

                    // Вызов плавного перехода
                    transitionToApp(data.redirect_link); // <-- ИЗМЕНЕНИЕ ЗДЕСЬ
                    
                } else {
                    toggleLoadingOverlay(false);
                    
                    const isBlockingError = BLOCKED_MESSAGES.some(msg => data.message && data.message.includes(msg));
                    
                    if (isBlockingError) {
                        lockVerificationControls();
                    } else {
                        codeBoxes.forEach(box => {
                            box.value = ''; 
                        });
                        codeBoxes[0].focus();
                        if (!resendCodeButton.classList.contains('blocked')) {
                            startResendCountdown(0); 
                        }
                    }

                    codeBoxes.forEach(box => box.classList.add('error-border'));
                    codeError.textContent = data.message || CONNECTION_ERROR_TEXT; 
                    codeError.style.display = "block";
                }
                
            } catch (error) {
                console.error("Fetch Error during code check:", error);
                toggleLoadingOverlay(false);
                codeError.textContent = CONNECTION_ERROR_TEXT;
                codeError.style.display = "block";
                lockVerificationControls();
            }
        }

        /* ---------------------------------------------------- */
        /* --- ЛОГИКА НАВИГАЦИИ --- */
        /* ---------------------------------------------------- */
        
        function goToVerificationPage(email, initialTime = RESEND_TIME) {
            currentEmail = email;
            verificationEmailSpan.textContent = email;
            
            resendCodeButton.classList.remove('blocked');
            codeBoxes.forEach(box => box.disabled = false);

            authFormContainer.classList.add('slide-out');
            codeVerificationContainer.classList.add('slide-in');
            
            setupCodeInput(); 
            startResendCountdown(initialTime); 
            
            codeVerificationContainer.addEventListener('transitionend', function handler() {
                if (codeVerificationContainer.classList.contains('slide-in')) {
                    codeBoxes[0].focus(); 
                    codeVerificationContainer.removeEventListener('transitionend', handler);
                }
            });
        }

        function goToAuthPage() {
            clearInterval(countdownInterval); 
            
            codeBoxes.forEach(box => {
                box.value = '';
                box.classList.remove('error-border');
                box.disabled = false; 
            });
            codeError.style.display = "none";
            resendCodeButton.classList.remove('blocked'); 
            
            codeVerificationContainer.classList.remove('slide-in');
            authFormContainer.classList.remove('slide-out'); 
            
            authFormContainer.addEventListener('transitionend', function handler() {
                if (!authFormContainer.classList.contains('slide-out')) {
                    emailInput.focus();
                    authFormContainer.removeEventListener('transitionend', handler);
                }
            });
            
            checkButtonState(); 
        }
        
        changeGmailButton.addEventListener("click", goToAuthPage);
        
        resendCodeButton.addEventListener("click", async function() {
            if (resendCodeButton.disabled) return;
            if (checkAndroidVersion('code')) return; 
            
            toggleLoadingOverlay(true);
            resendCodeButton.disabled = true; 
            codeError.style.display = "none";
            codeBoxes.forEach(b => b.classList.remove('error-border'));
            
            try {
                const formData = new URLSearchParams();
                formData.append('email', currentEmail);
                formData.append('resend', 'true'); 

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                toggleLoadingOverlay(false);

                if (data.success) {
                    console.log(`Новый код отправлен на ${currentEmail}.`);
                    codeRequestTimestamp = new Date().getTime(); 
                    lastCodeRequestEmail = currentEmail; 
                    startResendCountdown(); 
                    codeBoxes.forEach(box => box.value = '');
                    codeBoxes[0].focus(); 
                } else {
                    console.error("Ошибка повторной отправки:", data.message);
                    const isBlockingError = BLOCKED_MESSAGES.some(msg => data.message && data.message.includes(msg));
                    if (isBlockingError) {
                         lockVerificationControls();
                    } else {
                        resendCodeButton.disabled = true;
                        resendCodeButton.textContent = "Ошибка отправки";
                    }
                    codeError.textContent = data.message || CONNECTION_ERROR_TEXT;
                    codeError.style.display = "block";
                }
            } catch (error) {
                console.error("Fetch Error during resend code:", error);
                toggleLoadingOverlay(false);
                codeError.textContent = CONNECTION_ERROR_TEXT;
                codeError.style.display = "block";
                lockVerificationControls();
            }
        });

        let hasLoginError = false;

        function toggleFormElements(disabled) {
            emailInput.disabled = disabled;
            getCodeButton.disabled = disabled || !getCodeButton.classList.contains("active"); 
        }

        emailInput.addEventListener("focus", function() {
            emailInput.classList.remove("error-border");
            emailError.style.display = "none";
            hasLoginError = false;
            checkButtonState();
        });

        emailInput.addEventListener("blur", function() {
            if (emailInput.value.trim() !== "" && !isValidEmail(emailInput.value)) {
                emailInput.classList.add("error-border");
                emailError.textContent = "Введи действительный адрес Gmail";
                emailError.style.display = "block";
                hasLoginError = true;
            } else {
                emailInput.classList.remove("error-border");
                emailError.style.display = "none";
                hasLoginError = false;
            }
            checkButtonState();
        });

         emailInput.addEventListener("input", function(event) {
            emailInput.classList.remove("error-border");
            emailError.style.display = "none";
            hasLoginError = false;
            checkButtonState();
        });

        function checkButtonState() {
            const isEmailValid = isValidEmail(emailInput.value);
            if (isEmailValid && !hasLoginError) {
                getCodeButton.classList.add("active");
                getCodeButton.disabled = false;
            } else {
                getCodeButton.classList.remove("active");
                getCodeButton.disabled = true;
            }
        }

        getCodeButton.addEventListener("click", async function() {
            if (getCodeButton.disabled) return;
            const email = emailInput.value.trim();
            if (!isValidEmail(email)) {
                emailInput.classList.add("error-border");
                emailError.textContent = "Пожалуйста, введите действительный адрес Gmail.";
                emailError.style.display = "block";
                hasLoginError = true;
                checkButtonState();
                return;
            }
            if (checkAndroidVersion('auth')) return; 
            
            const currentTime = new Date().getTime();
            const timeElapsed = (currentTime - codeRequestTimestamp) / 1000;
            const isSameEmail = email === lastCodeRequestEmail;
            
            if (isSameEmail && timeElapsed < RESEND_TIME && codeRequestTimestamp !== 0) {
                toggleLoadingOverlay(true);
                toggleFormElements(true);
                setTimeout(() => {
                    toggleLoadingOverlay(false);
                    toggleFormElements(false);
                    let timeLeft = Math.ceil(RESEND_TIME - timeElapsed);
                    goToVerificationPage(email, timeLeft); 
                }, 200); 
                return; 
            }
            
            toggleLoadingOverlay(true);
            toggleFormElements(true);

            try {
                const formData = new URLSearchParams();
                formData.append('email', email);
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                if (data.success) {
                    codeRequestTimestamp = new Date().getTime();
                    lastCodeRequestEmail = email; 
                    toggleLoadingOverlay(false);
                    toggleFormElements(false);
                    goToVerificationPage(email, RESEND_TIME); 
                } else {
                    hasLoginError = true;
                    emailInput.classList.add("error-border");
                    emailError.textContent = data.message || CONNECTION_ERROR_TEXT; 
                    emailError.style.display = "block";
                    toggleLoadingOverlay(false);
                    toggleFormElements(false);
                    getCodeButton.classList.remove("active");
                    getCodeButton.disabled = true;
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                hasLoginError = true;
                emailInput.classList.add("error-border");
                emailError.textContent = CONNECTION_ERROR_TEXT; 
                emailError.style.display = "block";
                toggleLoadingOverlay(false);
                toggleFormElements(false);
                getCodeButton.classList.remove("active");
                getCodeButton.disabled = true;
            }
        });
        
        const INITIAL_ANIMATION_DURATION = 3000; 

        function startInitialAnimation() {
            toggleLoadingOverlay(true); 
            setTimeout(() => {
                toggleLoadingOverlay(false); 
                authFormContainer.classList.remove('hidden');
            }, INITIAL_ANIMATION_DURATION);
        }

        function setupForm() {
            checkButtonState();
            authFormContainer.classList.add('hidden'); 
            authFormContainer.classList.remove('slide-out');
            codeVerificationContainer.classList.remove('slide-in');
        }

        const isLoggedIn = localStorage.getItem(isLoggedInKey);
        const sessionExpires = localStorage.getItem(sessionExpiresKey);
        const storedEmail = localStorage.getItem(userEmailKey);
        const storedAuthToken = localStorage.getItem(authTokenKey); 
        const initialCurrentTime = new Date().getTime();
        
        let shouldCheckToken = false;
        
        if (isLoggedIn === 'true' && sessionExpires && parseInt(sessionExpires, 10) > initialCurrentTime && storedEmail && storedAuthToken) {
            shouldCheckToken = true;
        } else {
            clearLocalStorageSession();
        }

        async function initialize() {
            if (shouldCheckToken) {
                const tokenVerified = await verifyStoredToken(storedEmail, storedAuthToken);
                if (tokenVerified) {
                    return; 
                }
            }
            setupForm(); 
            startInitialAnimation(); 
        }

        initialize(); 
        
        document.getElementById('privacy-policy-link').addEventListener('click', function(e) {
            e.preventDefault(); 
            window.open(this.href, '_blank');
        });

        document.getElementById('terms-of-service-link').addEventListener('click', function(e) {
            e.preventDefault(); 
            window.open(this.href, '_blank');
        });
        
    </script>
</body>
</html>
