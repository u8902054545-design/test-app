<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Расписание смен</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#0F0F0F',
                        'accent-blue': '#0000FF', 
                        'text-light': '#E0E0E0',
                        'text-muted': '#A0A0A0',
                        'surface-dark': '#1A1A1A', 
                        'surface-light': '#2A2A2A',
                        'blue-900': '#1E3A8A', 
                        'info-surface': '#252525',
                        'page-bg': '#0F0F0F',
                        'card-bg': '#1A1A1A',
                        'bs-bg': '#121212',
                        'blue-status': '#0000FF',
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body { background-color: #0F0F0F; color: #E0E0E0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Стили Спинера */
        .spinner { width: 60px; height: 60px; animation: rotate 2s linear infinite; transform-origin: center center; }
        .path { stroke: #0000FF; stroke-linecap: round; stroke-width: 4; stroke-dasharray: 1, 150; animation: dash 1.5s ease-in-out infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash {
            0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 70, 150; stroke-dashoffset: -25px; }
            100% { stroke-dasharray: 70, 150; stroke-dashoffset: -125px; }
        }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(15, 15, 15, 0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0; visibility: hidden; pointer-events: none;
        }
        #loadingOverlay.visible { opacity: 1; visibility: visible; pointer-events: auto; }

        .hide-scrollbar::-webkit-scrollbar { height: 0px; background: transparent; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Bottom Sheet */
        .bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.6);
            background-color: #121212;
        }
        
        .time-btn {
            border: 1px solid #333; background-color: #1A1A1A; color: #E0E0E0;
            transition: all 0.2s; min-width: 80px; flex-shrink: 0; text-align: center;
        }
        .time-btn.selected { background-color: #0000FF; border-color: #0000FF; color: white; font-weight: 700; }

        /* --- СТИЛИ НИЖНЕГО МЕНЮ --- */
        .nav-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 500px;
            height: 70px; 
            background-color: #1E1F20;
            border-radius: 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            z-index: 50;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #E3E3E3;
            text-decoration: none;
        }

        .nav-item svg { width: 22px; height: 22px; }

        .nav-item.active {
            background-color: #0000FF;
            color: #FFFFFF;
        }
        
        .nav-item:active { transform: scale(0.9); }

        .btn-save { padding: 12px; border-radius: 6px; background-color: #0000FF; color: white; width: 100%; font-weight: 600; text-align: center; }
        .btn-save:disabled { background-color: #1A1A1A; color: #555; border: 1px solid #333; }
        .btn-delete { padding: 12px; border-radius: 6px; background-color: #121212; border: 1px solid #0000FF; color: #0000FF; width: 100%; font-weight: 600; text-align: center; margin-top: 12px; }

        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    </style>
</head>

<body class="min-h-screen relative overflow-x-hidden">

    <div id="toast-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[110] flex flex-col items-center gap-3 w-full max-w-sm pointer-events-none px-4"></div>

    <div id="loadingOverlay">
        <svg class="spinner" viewBox="25 25 50 50">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10" />
        </svg>
    </div>

    <header class="fixed top-0 left-0 w-full z-10 bg-primary-dark px-3 py-1 border-b border-surface-dark/50">
        <div class="relative flex justify-center items-center h-10 mb-2 pt-0">
            <h1 class="text-lg font-bold text-text-light text-center tracking-wide" style="font-size: 16px;">Расписание</h1>
        </div>
    </header>

    <div class="h-14"></div>

    <div class="w-full px-3 pb-32"> 
        <div id="calendar-container" class="space-y-1 pb-4"></div>
    </div>

    <nav class="nav-bar" id="main-nav">
        <a href="https://u8902054545-design.github.io/DarkCenter-Cloud-User-Main/" class="nav-item">
            <i data-lucide="home"></i>
        </a>
        
        <a href="https://u8902054545-design.github.io/DarkCenter-Cloud-Slot-Schedule/" class="nav-item active">
            <i data-lucide="calendar-days"></i>
        </a>

        <a href="https://u8902054545-design.github.io/cloud-center/" class="nav-item">
            <i data-lucide="map-pin"></i>
        </a>

        <a href="https://u8902054545-design.github.io/payments-darkcenter" class="nav-item">
            <i data-lucide="credit-card"></i>
        </a>

        <a href="https://u8902054545-design.github.io/education-darkcenter" class="nav-item">
            <i data-lucide="graduation-cap"></i>
        </a>

        <a href="https://u8902054545-design.github.io/chats-darkcenter" class="nav-item">
            <i data-lucide="message-square-more"></i>
        </a>
    </nav>

    <div id="bs-backdrop" class="fixed inset-0 bg-black/70 z-40 hidden opacity-0 transition-opacity duration-300" onclick="closeBottomSheet()"></div>
    <div id="bs-container" class="fixed bottom-0 left-0 w-full z-50 rounded-t-2xl transform translate-y-full bottom-sheet flex flex-col max-h-[85vh]">
        <div class="absolute top-4 right-4 text-text-muted p-1" onclick="closeBottomSheet()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        <div class="w-full flex justify-center pt-3 pb-1" onclick="closeBottomSheet()"><div class="w-12 h-1.5 bg-gray-600 rounded-full"></div></div>
        <div class="px-5 py-3 border-b border-white/10"><h2 id="bs-title" class="text-lg font-bold text-white pr-6">Интервал</h2></div>
        <div class="p-5 overflow-y-auto flex-1">
            <div class="mb-6">
                <p class="text-sm text-text-muted mb-3 font-medium">Время начала</p>
                <div id="start-time-scroll" class="flex overflow-x-auto space-x-3 hide-scrollbar pb-2"></div>
            </div>
            <div id="end-time-wrapper" class="hidden mb-2 opacity-0 transition-opacity duration-300">
                <p class="text-sm text-text-muted mb-3 font-medium">Время завершения</p>
                <div id="end-time-scroll" class="flex overflow-x-auto space-x-3 hide-scrollbar pb-2"></div>
            </div>
        </div>
        <div class="p-5 border-t border-white/10 bg-bs-bg w-full pb-10">
            <button id="btn-save-interval" class="btn-save" disabled onclick="saveInterval()">Сохранить</button>
            <button id="btn-delete-interval" class="btn-delete hidden" onclick="openDeleteConfirmation()">Удалить интервал</button>
        </div>
    </div>

    <div id="confirm-backdrop" class="fixed inset-0 bg-black/70 z-[60] hidden opacity-0 transition-opacity duration-300" onclick="closeDeleteConfirmation()"></div>
    <div id="confirm-container" class="fixed bottom-0 left-0 w-full z-[70] rounded-t-2xl transform translate-y-full bottom-sheet bg-bs-bg p-6">
        <div class="w-full flex justify-center mb-4"><div class="w-12 h-1.5 bg-gray-600 rounded-full"></div></div>
        <h2 class="text-xl font-bold text-white mb-2">Удалить интервал?</h2>
        <div class="space-y-3 mt-6">
            <button onclick="confirmDelete()" class="w-full py-4 bg-accent-blue text-white font-bold rounded-xl">Удалить</button>
            <button onclick="closeDeleteConfirmation()" class="w-full py-4 bg-transparent border border-gray-600 text-white font-bold rounded-xl">Отмена</button>
        </div>
        <div class="h-6"></div>
    </div>

    <script>
        // Инициализация иконок меню
        lucide.createIcons();

        const API_URL = "https://script.google.com/macros/s/AKfycbwJm1fzRK0KIBNbwl_wI1aOctRL-zKQ7u41Gj-_lYe0JHRjkOA2wGm7GO12OS9fZCdk/exec";
        const AUTH_PAGE_URL = "https://u8902054545-design.github.io/Auth-ITC-Platform/";
        
        let userEmail = localStorage.getItem('userEmail');
        let authToken = localStorage.getItem('authToken');

        function logout() { localStorage.clear(); window.location.href = AUTH_PAGE_URL; }
        if (!userEmail || !authToken) logout();

        async function validateAccess() {
            try {
                const response = await fetch(`${API_URL}?action=check_auth&userEmail=${encodeURIComponent(userEmail)}&authToken=${encodeURIComponent(authToken)}`);
                const result = await response.json();
                if (!result.authorized) logout();
            } catch (e) { console.error("Auth check failed", e); }
        }

        const shiftsMap = new Map();
        const today = new Date(); today.setHours(0,0,0,0);
        let isSheetOpen = false;

        function showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('visible', show); }

        async function loadData(isSilent = false) {
            if (isSilent && isSheetOpen) return;
            if (!isSilent) showLoading(true);
            try {
                const resp = await fetch(`${API_URL}?userEmail=${encodeURIComponent(userEmail)}&authToken=${encodeURIComponent(authToken)}`);
                const data = await resp.json();
                shiftsMap.clear();
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        if (item.interval) {
                            let type = 'pending';
                            if (item.status === 'Подтверждён') type = 'confirmed';
                            else if (item.status === 'Не подтверждён') type = 'unconfirmed';
                            else if (item.status === 'Отменён') type = 'canceled';
                            else if (item.status === 'Завершён') type = 'completed';
                            shiftsMap.set(item.date, { type, time: item.interval, duration: item.duration });
                        }
                    });
                }
                renderCalendar();
            } catch (e) { console.error("Ошибка сети", e); }
            finally { if (!isSilent) showLoading(false); }
        }

        function getWeekKey(date) {
            const day = date.getDay();
            const diff = date.getDate() - (day === 0 ? 6 : day - 1);
            return new Date(date.getFullYear(), date.getMonth(), diff).toDateString();
        }

        function formatWeekHeader(date) {
            const day = date.getDay();
            const start = new Date(date); start.setDate(date.getDate() - (day === 0 ? 6 : day - 1));
            const end = new Date(start); end.setDate(start.getDate() + 6);
            const df = new Intl.DateTimeFormat('ru-RU', { day: 'numeric', month: 'long' });
            return (df.format(start) + ' — ' + df.format(end)).replace(/^\w/, c => c.toUpperCase());
        }

        const ICON_PLUS = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`;

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const dayNames = ['вс', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'];
            let currentWeek = '';
            let html = '';
            for (let i = -30; i <= 30; i++) {
                const date = new Date(today); date.setDate(today.getDate() + i);
                const dateKey = date.toDateString();
                const weekKey = getWeekKey(date);
                if (weekKey !== currentWeek) {
                    currentWeek = weekKey;
                    html += `<div class="text-left text-xl font-bold text-text-light mt-4 mb-2 pl-2">${formatWeekHeader(date)}</div>`;
                }
                const isToday = date.getTime() === today.getTime();
                const isPast = date.getTime() < today.getTime();
                const shift = shiftsMap.get(dateKey);
                html += `
                <div class="flex items-center space-x-3 p-2 rounded-lg" ${isToday ? 'id="today-marker"' : ''}>
                    <div class="flex flex-col items-center flex-shrink-0 w-12 p-2 rounded-lg ${isToday ? 'bg-accent-blue' : (isPast ? '' : 'hover:bg-surface-dark')}">
                        <span class="text-xs font-semibold ${isToday ? 'text-white' : 'text-text-muted'}">${dayNames[date.getDay()]}</span>
                        <span class="text-xl font-bold mt-0.5 ${isToday ? 'text-white' : (isPast ? 'text-text-muted' : 'text-text-light')}">${date.getDate()}</span>
                    </div>
                    <div class="flex-grow flex">
                        ${shift ? getCardHTML(shift, dateKey) : (isPast ? '<div class="flex-grow h-12 flex items-center p-4 rounded-lg bg-surface-dark text-sm font-semibold text-text-muted">Неактивный</div>' : `<div onclick="openBottomSheetByDate('${date.toISOString()}')" class="w-12 h-12 flex items-center justify-center rounded-md bg-surface-dark text-accent-blue cursor-pointer">${ICON_PLUS}</div>`)}
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function getCardHTML(s, dKey) {
            const ICON_CHECK = `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>`;
            const ICON_CLOCK = `<svg class="w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
            
            let icon, bg, txt, clr;
            if (s.type==='confirmed') { icon=ICON_CHECK; bg="bg-green-500"; txt="Подтверждён"; clr="text-green-400"; }
            else if (s.type==='completed') { icon=ICON_CHECK; bg="bg-blue-status"; txt="Завершён"; clr="text-blue-400"; }
            else if (s.type==='pending') { icon=ICON_CLOCK; bg="bg-page-bg border-2 border-yellow-500"; txt="Ожидает подтверждения"; clr="text-yellow-500"; }
            else { icon=ICON_CHECK; bg="bg-red-600"; txt="Отменён"; clr="text-red-400"; }

            const clickAttr = s.type === 'pending' ? `onclick="openBottomSheetByDate('${new Date(dKey).toISOString()}', true, '${s.time}')"` : '';
            return `<div ${clickAttr} class="bg-card-bg text-white p-3 rounded-xl flex justify-between items-center flex-grow cursor-pointer"><div class="flex items-center space-x-2"><div class="w-7 h-7 rounded-full ${bg} flex items-center justify-center">${icon}</div><div><span class="text-xs font-semibold ${clr}">${txt}</span><p class="text-sm font-bold">${s.time}</p></div></div><p class="text-lg font-bold">${s.duration}</p></div>`;
        }

        let currentState = { date: null, start: null, end: null };

        function openBottomSheetByDate(dateIso, isEdit = false, existingInterval = null) {
            currentState.date = new Date(dateIso);
            isSheetOpen = true;
            document.getElementById('bs-title').textContent = `Интервал на ${new Intl.DateTimeFormat('ru-RU', { day: 'numeric', month: 'long' }).format(currentState.date)}`;
            document.getElementById('btn-delete-interval').classList.toggle('hidden', !isEdit);
            renderStartScroll();
            document.getElementById('bs-backdrop').classList.remove('hidden');
            setTimeout(() => document.getElementById('bs-backdrop').classList.remove('opacity-0'), 10);
            document.getElementById('bs-container').classList.remove('translate-y-full');
            document.body.style.overflow = 'hidden';
        }

        function renderStartScroll() {
            const startScroll = document.getElementById('start-time-scroll');
            startScroll.innerHTML = '';
            for (let i=0; i<24; i++) {
                const b = document.createElement('button');
                b.className = 'time-btn p-2 rounded text-sm font-medium';
                b.textContent = i.toString().padStart(2,'0')+':00';
                b.onclick = () => {
                    currentState.start = i;
                    document.querySelectorAll('#start-time-scroll .time-btn').forEach(x=>x.classList.remove('selected'));
                    b.classList.add('selected');
                    renderEndScroll(i);
                };
                startScroll.appendChild(b);
            }
        }

        function renderEndScroll(start) {
            const endScroll = document.getElementById('end-time-scroll');
            endScroll.innerHTML = '';
            for (let h=start+2; h<=start+18; h++) {
                const d = h >= 24 ? h-24 : h;
                const b = document.createElement('button');
                b.className = 'time-btn p-2 rounded text-sm font-medium';
                b.textContent = d.toString().padStart(2,'0')+':00'+(h>=24?' (+1)':'');
                b.onclick = () => {
                    currentState.end = h;
                    document.querySelectorAll('#end-time-scroll .time-btn').forEach(x=>x.classList.remove('selected'));
                    b.classList.add('selected');
                    document.getElementById('btn-save-interval').disabled = false;
                };
                endScroll.appendChild(b);
            }
            document.getElementById('end-time-wrapper').classList.remove('hidden');
            setTimeout(()=>document.getElementById('end-time-wrapper').classList.remove('opacity-0'), 50);
        }

        function closeBottomSheet() {
            isSheetOpen = false;
            document.getElementById('bs-backdrop').classList.add('opacity-0');
            document.getElementById('bs-container').classList.add('translate-y-full');
            setTimeout(() => { document.getElementById('bs-backdrop').classList.add('hidden'); document.body.style.overflow = ''; }, 300);
        }

        function openDeleteConfirmation() {
            document.getElementById('confirm-backdrop').classList.remove('hidden');
            setTimeout(() => document.getElementById('confirm-backdrop').classList.remove('opacity-0'), 10);
            document.getElementById('confirm-container').classList.remove('translate-y-full');
        }

        function closeDeleteConfirmation() {
            document.getElementById('confirm-backdrop').classList.add('opacity-0');
            document.getElementById('confirm-container').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('confirm-backdrop').classList.add('hidden'), 300);
        }

        async function confirmDelete() {
            closeDeleteConfirmation();
            showLoading(true);
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({
                    action: 'delete', userEmail, authToken, date: currentState.date.toISOString()
                })});
                closeBottomSheet(); await loadData();
            } catch (err) { showLoading(false); }
        }

        async function saveInterval() {
            showLoading(true);
            const s = currentState.start.toString().padStart(2,'0')+':00';
            const e = (currentState.end >= 24 ? currentState.end-24 : currentState.end).toString().padStart(2,'0')+':00';
            const suffix = currentState.end >= 24 ? ' (+1)' : '';
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({
                    action: 'save', userEmail, authToken, date: currentState.date.toISOString(),
                    interval: `${s} — ${e}${suffix}`, duration: `${currentState.end - currentState.start} ч`
                })});
                closeBottomSheet(); await loadData();
            } catch (err) { showLoading(false); }
        }

        window.onload = async () => {
            await validateAccess();
            await loadData();
            setTimeout(() => {
                const el = document.getElementById('today-marker');
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
            setInterval(async () => { await loadData(true); }, 5000);
        };
    </script>
</body>
</html>
