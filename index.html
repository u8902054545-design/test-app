<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Авторизация ITC Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Basic Styles and Reset --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #000000;
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            box-sizing: border-box;
            overflow: hidden; /* Предотвращаем прокрутку при переходах */
        }

        /* --- Defining CSS variables for colors --- */
        :root {
            --color-blue: #0000FF;
            --color-purple: #0000FF; 
            --color-red: #ff0000;
            --animation-duration: 3s;
            --transition-duration: 0.5s; 
        }
        
        /* --- Стили для IFRAME (Финальная страница) --- */
        #contentFrame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none; /* Скрыт до успешной авторизации */
            z-index: 50;
            background-color: #000000;
        }

        /* ---------------------------------------------------- */
        /* --- НОВАЯ АНИМАЦИЯ ЗАГРУЗКИ (Google Play Style) --- */
        /* ---------------------------------------------------- */

        #overlay-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); 
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Самый высокий приоритет */
            transition: opacity var(--transition-duration) ease, visibility var(--transition-duration) ease;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        #overlay-loading.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            display: flex; 
        }
        
        .spinner {
            width: 60px; 
            height: 60px;
            animation: rotate 2s linear infinite; 
            transform-origin: center center;
        }

        .path {
            stroke: var(--color-blue); 
            stroke-linecap: round;
            stroke-width: 4; 
            stroke-dasharray: 1, 150; 
            animation: dash 1.5s ease-in-out infinite; 
        }

        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        @keyframes dash {
            0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 70, 150; stroke-dashoffset: -25px; }
            100% { stroke-dasharray: 70, 150; stroke-dashoffset: -125px; }
        }
        
        /* ---------------------------------------------------- */
        /* --- Анимации перехода страниц --- */
        /* ---------------------------------------------------- */
        
        #authFormContainer.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #authFormContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #000000;
            color: white;
            font-family: sans-serif;
            box-sizing: border-box;
            width: 100%;
            position: fixed; 
            top: 0;
            left: 0; 
            bottom: 0;
            z-index: 99; 
            transform: translateX(0); 
            transition: transform var(--transition-duration) ease-in-out, opacity var(--transition-duration) ease-in-out; 
        }
        
        /* Класс для ухода влево */
        #authFormContainer.slide-out,
        #codeVerificationContainer.slide-out {
            transform: translateX(-100%) !important; 
        }
        
        #codeVerificationContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #000000;
            color: white;
            font-family: sans-serif;
            box-sizing: border-box;
            width: 100%;
            position: fixed; 
            top: 0;
            left: 0; 
            bottom: 0;
            z-index: 98; 
            transform: translateX(100%); 
            transition: transform var(--transition-duration) ease-in-out; 
        }
        
        #codeVerificationContainer.slide-in {
            transform: translateX(0); 
        }

        .page-content {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 5px 15px 150px; 
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            height: 100%; 
        }
        
        /* --- Заголовки и инпуты --- */
        .darkcenter-title {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
            margin-top: 10px;
            background-image: linear-gradient(to right, #0000FF, #0000FF, #ff0000, #0000FF, #0000FF);
            background-size: 400% 100%;
            animation: gradientFlow-new 4s linear infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        @keyframes gradientFlow-new {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .login-title {
            font-weight: bold;
            font-size: 22px;
            margin-top: 0;
            margin-bottom: 10px; 
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            padding: 0 1px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #AAAAAA;
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            padding: 0 1px;
            line-height: 1.4;
        }
        
        .input-group {
            position: relative;
            box-sizing: border-box;
            width: 100%;
            margin-bottom: 15px;
            padding: 0 1px;
        }

        .input-group .input-field {
            width: 100%;
            padding: 24px 11px 8px;
            height: 56px;
            background-color: #000000;
            border: 1px solid #615f5f;
            border-radius: 12px;
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s ease;
            font-size: 16px;
            caret-color: var(--color-blue); 
        }

        .input-group .input-label {
            position: absolute;
            top: 50%;
            left: 13px;
            transform: translateY(-50%);
            color: #615f5f;
            pointer-events: none;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .input-group .input-field:focus { border: 2px solid #0000FF; }
        .input-group .input-field:focus + .input-label { color: #0000FF; }
        .input-group .input-field:focus + .input-label,
        .input-group .input-field:not(:placeholder-shown) + .input-label {
            top: 0;
            left: 10px;
            transform: translateY(-50%) scale(0.75);
            background-color: #000000;
            padding: 0 4px;
        }

        .error-message {
            color: #FF7F7F;
            font-size: 12px;
            margin-top: 5px;
            text-align: left;
            display: none;
            width: 100%;
        }

        .error-border { border-color: #FF7F7F !important; }

        .code-input-grid {
            display: flex;
            justify-content: space-between;
            gap: 8px; 
            width: 100%;
            max-width: 350px; 
            margin-bottom: 25px;
            box-sizing: border-box;
        }

        .code-input-grid .code-box {
            width: 45px;
            height: 45px;
            font-size: 24px;
            text-align: center;
            background-color: #1a1a1a;
            border: 2px solid #615f5f;
            border-radius: 8px;
            color: white;
            outline: none;
            transition: border-color 0.2s ease;
            caret-color: var(--color-blue); 
        }
        
        .code-input-grid .code-box:focus {
            border-color: var(--color-blue);
            box-shadow: 0 0 5px var(--color-blue);
        }

        .fixed-button-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000000;
            padding: 10px 15px;
            box-sizing: border-box;
            z-index: 10;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 430px) {
            .fixed-button-container { max-width: none; left: 0; transform: none; }
        }
        
        .action-button {
            width: 100%;
            padding: 12px; 
            border: none;
            border-radius: 6px; 
            font-size: 16px;
            margin-bottom: 10px; 
        }
        
        #get-code-button {
            background-color: rgba(0, 0, 255, 0.5);
            color: rgba(255, 255, 255, 0.7);
            cursor: not-allowed;
            transition: all 0.1s ease;
        }

        #get-code-button.active {
            background-color: #0000FF;
            color: white;
            cursor: pointer;
        }

        #change-gmail-button { background-color: var(--color-blue); color: white; cursor: pointer; font-weight: 600; }
        #resend-code-button { background-color: transparent; color: var(--color-blue); border: 1px solid var(--color-blue); cursor: pointer; }
        #resend-code-button:disabled { border-color: rgba(0, 0, 255, 0.5); color: rgba(0, 0, 255, 0.5); }
        
        .footer-text { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
        .footer-text a { color: var(--color-blue); text-decoration: none; pointer-events: auto; }
        .app-version { font-size: 10px; color: #555; text-align: center; margin-top: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <!-- Спиннер загрузки -->
    <div id="overlay-loading">
        <svg class="spinner" viewBox="25 25 50 50" role="status" aria-label="Загрузка">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10" />
        </svg>
    </div>

    <!-- Iframe для загрузки контента после авторизации -->
    <iframe id="contentFrame" src="about:blank"></iframe>

    <!-- Контейнер авторизации (Страница 1) -->
    <div id="authFormContainer" class="hidden"> 
        <div class="page-content"> 
            <div class="darkcenter-title">ITC Platform</div>
            <div class="login-title">Введи свой Gmail</div> 
            <div class="login-subtitle">На твой Gmail будет отправлен код для входа, или совершён звонок по Google Meet, чтобы продиктовать код</div>

            <div class="input-group">
                <input type="email" id="email-input" class="input-field" placeholder=" ">
                <label for="email-input" class="input-label">Gmail</label>
                <div id="email-error" class="error-message"></div>
            </div>
        </div>

        <div class="fixed-button-container">
            <button id="get-code-button" class="action-button" disabled>Получить код</button> 
            <div class="footer-text">
                Продолжая, ты соглашаешься с 
                <a id="privacy-policy-link" href="https://script.google.com/" target="_blank">политикой конфиденциальности</a> 
                и 
                <a id="terms-of-service-link" href="https://script.google.com/" target="_blank">условиями сервиса</a>
            </div>
            <div class="app-version">DarkCenter Google Release, v2.5.8</div>
        </div>
    </div>
    
    <!-- Контейнер верификации (Страница 2) -->
    <div id="codeVerificationContainer">
        <div class="page-content"> 
            <div class="darkcenter-title">ITC Platform</div>
            <div class="login-title">Введи код подтверждения из Gmail</div> 
            <div class="login-subtitle">Отправили его на <span id="verification-email"></span></div> 

            <div class="code-input-grid">
                <input type="text" maxlength="1" class="code-box" id="code-input-1" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-2" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-3" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-4" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-5" pattern="[0-9]*" inputmode="numeric">
                <input type="text" maxlength="1" class="code-box" id="code-input-6" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div id="code-error" class="error-message" style="margin-top: -15px; margin-bottom: 25px;"></div>
        </div>

        <div class="fixed-button-container">
            <div class="code-page-buttons" style="width: 100%;">
                <button id="change-gmail-button" class="action-button">Изменить Gmail</button> 
                <button id="resend-code-button" class="action-button" disabled>Получить новый код — через <span id="resend-timer">25 с</span></button>
            </div>
        </div>
    </div>

    <script>
        const authFormContainer = document.getElementById('authFormContainer');
        const codeVerificationContainer = document.getElementById('codeVerificationContainer');
        const overlayLoading = document.getElementById('overlay-loading');
        const contentFrame = document.getElementById('contentFrame');
        const emailInput = document.getElementById("email-input");
        const getCodeButton = document.getElementById("get-code-button");
        const emailError = document.getElementById("email-error");
        const verificationEmailSpan = document.getElementById("verification-email");
        const changeGmailButton = document.getElementById("change-gmail-button");
        const resendCodeButton = document.getElementById("resend-code-button");
        const resendTimerSpan = document.getElementById("resend-timer");
        const codeBoxes = Array.from({length: 6}, (_, i) => document.getElementById(`code-input-${i+1}`));
        const codeError = document.getElementById("code-error");

        // --- КОНСТАНТЫ ---
        const isLoggedInKey = 'isLoggedIn';
        const userLinkKey = 'userLink';
        const sessionExpiresKey = 'sessionExpires';
        const userEmailKey = 'userEmail';
        const authTokenKey = 'authToken';
        
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz0uenNIXAbEI1ZqBLhTK06omyIMa3JquZ5Dil08MrY_jLsRCCff3W1PKQ6XgPM84td/exec"; 
        
        let currentEmail = "";
        let codeRequestTimestamp = 0;
        let lastCodeRequestEmail = "";
        const RESEND_TIME = 25;
        let countdownInterval;
        const BLOCKED_MESSAGES = ["Пользователь с таким Gmail не найден", "Твой аккаунт DarkCenter заблокирован"];
        const CONNECTION_ERROR_TEXT = "Не удалось подключиться к серверу. Проверь подключение к интернету и повтори попытку";

        // ----------------------------------------------------
        // --- НОВАЯ ФУНКЦИЯ ПЛАВНОГО ПЕРЕХОДА В IFRAME ---
        // ----------------------------------------------------
        function performIframeTransition(url) {
            // 1. Начинаем анимацию ухода текущих окон
            authFormContainer.classList.add('slide-out');
            codeVerificationContainer.classList.add('slide-out');

            // 2. Показываем спиннер загрузки
            toggleLoadingOverlay(true);

            // 3. Устанавливаем обработчик загрузки iframe
            contentFrame.onload = function() {
                // Как только iframe загрузился, скрываем спиннер и показываем iframe
                toggleLoadingOverlay(false);
                contentFrame.style.display = 'block';
            };

            // 4. Загружаем URL в iframe (происходит в фоне во время анимации)
            contentFrame.src = url;
        }

        // --- Вспомогательные функции ---
        function clearLocalStorageSession() {
            [isLoggedInKey, userLinkKey, sessionExpiresKey, userEmailKey, authTokenKey].forEach(k => localStorage.removeItem(k));
        }

        function toggleLoadingOverlay(show) {
            if (show) {
                overlayLoading.style.display = 'flex'; 
                setTimeout(() => overlayLoading.classList.add('visible'), 10);
            } else {
                overlayLoading.classList.remove('visible');
                setTimeout(() => {
                    if (!overlayLoading.classList.contains('visible')) overlayLoading.style.display = 'none';
                }, 500);
            }
        }

        function isValidEmail(email) {
            return /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email);
        }

        function startResendCountdown(initialTime = RESEND_TIME) {
            clearInterval(countdownInterval); 
            let timeLeft = initialTime;
            resendCodeButton.disabled = true;
            resendTimerSpan.textContent = `${timeLeft} с`;
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    if (!resendCodeButton.classList.contains('blocked')) {
                        resendCodeButton.disabled = false;
                        resendCodeButton.textContent = "Получить новый код";
                    }
                } else {
                    resendTimerSpan.textContent = `${timeLeft} с`;
                    resendCodeButton.textContent = `Получить новый код — через ${timeLeft} с`;
                }
            }, 1000);
        }

        function setupCodeInput() {
            codeBoxes.forEach((box, index) => {
                box.value = '';
                box.disabled = false;
                box.oninput = (e) => {
                    if (/\D/.test(e.target.value)) { e.target.value = ''; return; }
                    if (e.target.value.length === 1 && index < 5) codeBoxes[index+1].focus();
                    if (index === 5 && e.target.value.length === 1) { e.target.blur(); checkCode(); }
                };
                box.onkeydown = (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) codeBoxes[index-1].focus();
                };
            });
        }

        async function verifyStoredToken(email, token) {
            toggleLoadingOverlay(true);
            try {
                const formData = new URLSearchParams({ email, auth_token: token, check_token: 'true' });
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    // Используем плавный переход вместо replace
                    performIframeTransition(data.redirect_link);
                    return true;
                }
                clearLocalStorageSession();
                toggleLoadingOverlay(false);
                return false;
            } catch (e) {
                clearLocalStorageSession();
                toggleLoadingOverlay(false);
                return false;
            }
        }

        async function checkCode() {
            const code = codeBoxes.map(b => b.value).join('');
            if (code.length < 6) return;
            
            toggleLoadingOverlay(true);
            try {
                const formData = new URLSearchParams({ email: currentEmail, code: code });
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    clearInterval(countdownInterval);
                    const expirationTime = new Date().getTime() + (data.token_expiry_hours || 24) * 3600000;
                    localStorage.setItem(isLoggedInKey, 'true');
                    localStorage.setItem(userLinkKey, data.redirect_link); 
                    localStorage.setItem(sessionExpiresKey, expirationTime.toString());
                    localStorage.setItem(userEmailKey, currentEmail);
                    localStorage.setItem(authTokenKey, data.auth_token);

                    // Плавный переход в iframe
                    performIframeTransition(data.redirect_link);
                } else {
                    toggleLoadingOverlay(false);
                    codeError.textContent = data.message || CONNECTION_ERROR_TEXT;
                    codeError.style.display = "block";
                    codeBoxes.forEach(b => { b.value = ''; b.classList.add('error-border'); });
                    codeBoxes[0].focus();
                }
            } catch (e) {
                toggleLoadingOverlay(false);
                codeError.textContent = CONNECTION_ERROR_TEXT;
                codeError.style.display = "block";
            }
        }

        function goToVerificationPage(email, initialTime = RESEND_TIME) {
            currentEmail = email;
            verificationEmailSpan.textContent = email;
            authFormContainer.classList.add('slide-out');
            codeVerificationContainer.classList.add('slide-in');
            setupCodeInput();
            startResendCountdown(initialTime);
        }

        function goToAuthPage() {
            clearInterval(countdownInterval);
            codeVerificationContainer.classList.remove('slide-in');
            authFormContainer.classList.remove('slide-out');
            emailInput.focus();
        }

        // --- Event Listeners ---
        emailInput.oninput = () => {
            const valid = isValidEmail(emailInput.value);
            getCodeButton.classList.toggle('active', valid);
            getCodeButton.disabled = !valid;
            emailError.style.display = 'none';
            emailInput.classList.remove('error-border');
        };

        getCodeButton.onclick = async () => {
            if (getCodeButton.disabled) return;
            const email = emailInput.value.trim();
            
            // UX Проверка таймера
            const timeElapsed = (Date.now() - codeRequestTimestamp) / 1000;
            if (email === lastCodeRequestEmail && timeElapsed < RESEND_TIME && codeRequestTimestamp !== 0) {
                goToVerificationPage(email, Math.ceil(RESEND_TIME - timeElapsed));
                return;
            }

            toggleLoadingOverlay(true);
            try {
                const formData = new URLSearchParams({ email });
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await response.json();
                
                toggleLoadingOverlay(false);
                if (data.success) {
                    codeRequestTimestamp = Date.now();
                    lastCodeRequestEmail = email;
                    goToVerificationPage(email, RESEND_TIME);
                } else {
                    emailError.textContent = data.message || CONNECTION_ERROR_TEXT;
                    emailError.style.display = "block";
                    emailInput.classList.add("error-border");
                }
            } catch (e) {
                toggleLoadingOverlay(false);
                emailError.textContent = CONNECTION_ERROR_TEXT;
                emailError.style.display = "block";
            }
        };

        changeGmailButton.onclick = goToAuthPage;

        resendCodeButton.onclick = async () => {
            toggleLoadingOverlay(true);
            try {
                const formData = new URLSearchParams({ email: currentEmail, resend: 'true' });
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await response.json();
                toggleLoadingOverlay(false);
                if (data.success) {
                    codeRequestTimestamp = Date.now();
                    startResendCountdown();
                } else {
                    codeError.textContent = data.message || CONNECTION_ERROR_TEXT;
                    codeError.style.display = 'block';
                }
            } catch (e) { toggleLoadingOverlay(false); }
        };

        // --- Инициализация ---
        async function initialize() {
            const exp = localStorage.getItem(sessionExpiresKey);
            const token = localStorage.getItem(authTokenKey);
            const email = localStorage.getItem(userEmailKey);

            if (token && exp && parseInt(exp) > Date.now()) {
                const verified = await verifyStoredToken(email, token);
                if (verified) return;
            }

            // Обычный запуск с анимацией 3с
            toggleLoadingOverlay(true);
            setTimeout(() => {
                toggleLoadingOverlay(false);
                authFormContainer.classList.remove('hidden');
            }, 3000);
        }

        initialize();
    </script>
</body>
    </html>
