<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager & Assembly System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "fake-key", authDomain: "domain.com", projectId: "project" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'task-assembly-app';

        async function initApp() {
            try { await signInAnonymously(auth); } catch (error) { console.warn("Auth mode: local/fallback"); }
        }

        onAuthStateChanged(auth, (user) => { if (user) window.currentUser = user; });
        initApp();
        window.db = db;
        window.appId = appId;
    </script>

    <style>
        :root {
            --m3-surface: #0b1219;
            --m3-on-surface: #E6E1E5;
            --m3-surface-container: #161c24;
            --m3-primary: #a8c7fa;
            --m3-on-primary: #ffffff;
            --m3-secondary-container: #232a3b;
            --m3-on-secondary-container: #dce4f0;
            --m3-error: #F2B8B5;
            --m3-on-error: #601410;
            --m3-tertiary-container: #0f2e45; 
            --m3-on-tertiary-container: #c2e7ff;
            --m3-warning-container: #633b00;
            --m3-on-warning-container: #ffdcbe;
            --md-sys-color-primary: #0000FF; 
            --md-sys-color-outline: #4f5b68;
            --google-table-border: #3c4043;
            --google-table-header: #202124;
        }

        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            background-color: var(--m3-surface);
            color: var(--m3-on-surface);
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100dvh;
        }

        /* Кнопки */
        .m3-button {
            background-color: var(--md-sys-color-primary);
            color: var(--m3-on-primary);
            border-radius: 12px !important; /* Скругление 12px */
            padding: 14px 28px; /* Внутренние отступы 14px */
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 100%;
        }

        .bottom-fixed-btn {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            z-index: 50;
            max-width: calc(600px - 32px);
            margin: 0 auto;
        }

        /* Рамка и подсветка кода */
        .python-frame {
            border: 2px solid #0000FF; /* Синяя рамка 2px */
            border-radius: 12px;
            background: #1e1e1e;
            padding: 16px;
            overflow: auto;
            position: relative;
        }

        /* Цвета а-ля Google Apps Script */
        .code-keyword { color: #c586c0; }
        .code-func { color: #dcdcaa; }
        .code-string { color: #ce9178; }
        .code-comment { color: #6a9955; }
        .code-default { color: #9cdcfe; }

        /* Заголовки */
        .page-title { font-size: 16px; font-weight: 700; }

        /* Блок ID задачи */
        .task-id-badge {
            background: #0000FF;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* Спиннеры */
        .spinner { width: 48px; height: 48px; animation: rotate 2s linear infinite; }
        .path { stroke: #0000FF; stroke-linecap: round; stroke-width: 4; stroke-dasharray: 1, 150; animation: dash 1.5s ease-in-out infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash { 0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; } 50% { stroke-dasharray: 70, 150; stroke-dashoffset: -25px; } 100% { stroke-dasharray: 70, 150; stroke-dashoffset: -125px; } }

        /* Страницы */
        .page { position: fixed; inset: 0; transition: transform 0.4s ease; background: var(--m3-surface); z-index: 10; overflow-y: auto; padding-bottom: 100px; }
        .page-hidden { transform: translateX(100%); opacity: 0; }
        .page-active { transform: translateX(0); opacity: 1; z-index: 20; }

        .sticky-header {
            position: sticky; top: 0; height: 64px; background: var(--m3-surface);
            display: flex; align-items: center; padding: 0 16px; z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .m3-card { background: var(--m3-surface-container); border-radius: 12px; padding: 16px; border: 1px solid transparent; }
        .m3-chip { border-radius: 8px; padding: 6px 12px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; }
        .timer-default { background: var(--m3-tertiary-container); color: var(--m3-on-tertiary-container); }
        
        /* Notifications */
        .notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; padding: 14px; border-radius: 12px; z-index: 2000; transition: 0.4s; }
        .notification.show { top: 16px; }
        .notification-error { background: #920003; color: white; }
        .notification-complete { background: #D0BCFF; color: #381E72; }

        .m3-textfield input { width: 100%; background: transparent; border: 1px solid var(--md-sys-color-outline); border-radius: 12px; padding: 16px; color: white; outline: none; margin-top: 8px; }

        #auth-loader { position: fixed; inset: 0; background: var(--m3-surface); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="auth-loader">
        <svg class="spinner mb-4" viewBox="25 25 50 50"><circle class="path" cx="50" cy="50" r="20" fill="none"/></svg>
        <div class="text-sm">Загрузка системы...</div>
    </div>

    <div id="page-list" class="page page-active">
        <header class="sticky-header">
            <h1 class="page-title mx-auto">Разработка</h1>
        </header>
        <div class="p-4 max-w-md mx-auto space-y-4">
            <div id="active-tasks-wrapper" class="hidden">
                <h2 class="text-[11px] font-bold text-blue-400 uppercase tracking-widest mb-3" id="active-tasks-header">В работе</h2>
                <div id="active-tasks-container" class="space-y-3"></div>
            </div>
            <div id="task-counter-container" class="hidden">
                <h2 id="task-counter" class="text-2xl font-bold">Ожидают 0</h2>
            </div>
            <div id="tasks-container" class="space-y-3"></div>
        </div>
    </div>

    <div id="page-assembly" class="page page-hidden">
        <header class="sticky-header justify-between">
            <button onclick="closeAssembly()" class="p-2"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h1 class="page-title">Выполнение разработки</h1>
            <div id="assembly-timer" class="m3-chip timer-default">
                <i data-lucide="timer" class="w-3.5 h-3.5"></i>
                <span id="assembly-timer-text">--:--</span>
            </div>
        </header>

        <div class="p-6 max-w-xl mx-auto w-full">
            <div class="flex items-center justify-between mb-4">
                <div id="header-task-id" class="task-id-badge">ID: ----</div>
            </div>

            <div id="stage-coding" class="space-y-6">
                <div id="interactive-area" class="opacity-40 pointer-events-none transition-opacity">
                    <div class="python-frame">
                        <pre id="python-code-block" class="text-sm font-['Fira_Code']"></pre>
                        <button onclick="copyCode()" class="absolute top-2 right-2 p-2 text-blue-400"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <div id="action-area" class="hidden space-y-3">
                    <button id="return-code-btn" disabled onclick="handleReturnClick()" class="m3-button !bg-gray-800">Вернуть входной код</button>
                    <button id="secondary-btn" onclick="openAuthSheet()" class="m3-button !bg-blue-900/30 !text-blue-200 opacity-0 transition-all">Token input</button>
                </div>
            </div>

            <div id="stage-final" class="hidden space-y-6">
                <div class="bg-[#0b0a0d] p-6 rounded-xl border border-purple-900/30 font-['Fira_Code'] text-xs">
                    <span class="text-gray-500"># Finalizing...</span><br>
                    <span class="code-keyword">def</span> <span class="code-func">push</span>(data):<br>
                    &nbsp;&nbsp;<span class="code-keyword">return</span> <span class="code-string">"Success"</span><br><br>
                    ids = [<span id="final-code-entry" class="text-white">...</span>]
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="m3-textfield"><input type="text" id="final-block-1" placeholder="Block ID 1" oninput="updateFinalCode()"></div>
                    <div class="m3-textfield"><input type="text" id="final-block-2" placeholder="Block ID 2" oninput="updateFinalCode()"></div>
                </div>
            </div>
        </div>

        <div id="start-overlay" class="bottom-fixed-btn">
            <button id="btn-start-assembly" onclick="startAssembly()" class="m3-button">
                <i data-lucide="play" class="w-5 h-5"></i> Начать выполнение
            </button>
        </div>
        <div id="finish-btn-container" class="bottom-fixed-btn hidden">
            <button id="finish-task-btn" onclick="finalizeTaskProcess()" class="m3-button">
                <i data-lucide="check-circle" class="w-5 h-5"></i> Завершить выполнение
            </button>
        </div>
    </div>

    <div id="notif-error" class="notification notification-error"><span class="text-sm">Ошибка: Функция заблокирована</span></div>
    <div id="notif-complete" class="notification notification-complete text-center"><span class="font-bold">ЗАДАЧА ЗАВЕРШЕНА</span></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYIThLvfF1N6s2PhzvqvI5Q7YP_XWARDGVF80sjDyjAbUX34WeSazYBooafEBN2--Y/exec';
        let activeTaskId = null;
        let returnClickCount = 0;

        // Имитация раскраски кода (GAS Style)
        function highlightPython(code) {
            return code
                .replace(/\b(def|return|if|for|in|import|from|as|while)\b/g, '<span class="code-keyword">$1</span>')
                .replace(/\b(\w+)(?=\()/g, '<span class="code-func">$1</span>')
                .replace(/(['"].*?['"])/g, '<span class="code-string">$1</span>')
                .replace(/(#.*)/g, '<span class="code-comment">$1</span>');
        }

        async function checkUserAuthorization() {
            // Заглушка авторизации для демонстрации
            setTimeout(() => {
                document.getElementById('auth-loader').style.opacity = '0';
                setTimeout(() => document.getElementById('auth-loader').remove(), 500);
                initAppLogic();
            }, 1000);
        }

        function initAppLogic() {
            lucide.createIcons();
            // Здесь должна быть логика fetchTasks() и таймеров из вашего оригинала
        }

        async function startAssembly() {
            const btn = document.getElementById('btn-start-assembly');
            btn.disabled = true;
            btn.innerHTML = "Загрузка...";
            
            // Имитация получения кода
            const rawCode = "import os\ndef process_data(id):\n    # Task processing\n    print(f'Done {id}')\n    return True";
            document.getElementById('python-code-block').innerHTML = highlightPython(rawCode);
            
            setTimeout(() => {
                document.getElementById('start-overlay').classList.add('hidden');
                document.getElementById('interactive-area').style.opacity = '1';
                document.getElementById('interactive-area').style.pointerEvents = 'auto';
                document.getElementById('action-area').classList.remove('hidden');
            }, 800);
        }

        function handleReturnClick() {
            returnClickCount++;
            if(returnClickCount === 1) {
                document.getElementById('secondary-btn').classList.replace('opacity-0', 'opacity-100');
            } else {
                showNotification('notif-error');
            }
        }

        function openAuthSheet() {
            // Переход к финалу для демонстрации
            document.getElementById('stage-coding').classList.add('hidden');
            document.getElementById('stage-final').classList.remove('hidden');
            document.getElementById('finish-btn-container').classList.remove('hidden');
        }

        function updateFinalCode() {
            const b1 = document.getElementById('final-block-1').value || '...';
            const b2 = document.getElementById('final-block-2').value || '...';
            document.getElementById('final-code-entry').textContent = `"${b1}", "${b2}"`;
        }

        function closeAssembly() {
            document.getElementById('page-assembly').classList.add('page-hidden');
            document.getElementById('page-list').classList.remove('page-hidden');
        }

        function showNotification(id) {
            const el = document.getElementById(id);
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function copyCode() {
            const code = document.getElementById('python-code-block').innerText;
            navigator.clipboard.writeText(code);
            document.getElementById('return-code-btn').disabled = false;
        }

        window.onload = checkUserAuthorization;
    </script>
</body>
    </html>
