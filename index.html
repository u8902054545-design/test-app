<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager & Assembly System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "fake-key", authDomain: "domain.com", projectId: "project" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'task-assembly-app';

        async function initApp() {
            try { await signInAnonymously(auth); } catch (error) { console.warn("Auth mode: local/fallback"); }
        }

        onAuthStateChanged(auth, (user) => { if (user) window.currentUser = user; });
        initApp();
        window.db = db;
        window.appId = appId;
    </script>

    <style>
        :root {
            --m3-surface: #0b1219;
            --m3-on-surface: #E6E1E5;
            --m3-surface-container: #161c24;
            --m3-primary: #a8c7fa;
            --m3-on-primary: #ffffff;
            --m3-secondary-container: #232a3b;
            --m3-on-secondary-container: #dce4f0;
            --m3-error: #F2B8B5;
            --m3-on-error: #601410;
            --m3-tertiary-container: #0f2e45; 
            --m3-on-tertiary-container: #c2e7ff;
            --m3-warning-container: #633b00;
            --m3-on-warning-container: #ffdcbe;
            
            --md-sys-color-primary: #0000FF; 
            --md-sys-color-outline: #4f5b68;
            --google-table-border: #3c4043;
            --google-table-header: #202124;
            --active-task-color: #1a2230;
        }

        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            background-color: var(--m3-surface);
            color: var(--m3-on-surface);
            margin: 0; padding: 0; overflow: hidden; height: 100dvh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Кнопки управления */
        .m3-button {
            background-color: var(--md-sys-color-primary);
            color: white;
            border-radius: 12px; /* Изменено на 12px */
            padding: 14px 28px; /* Внутренние отступы 14px */
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 100%;
        }

        .m3-button-tonal {
            background-color: var(--m3-secondary-container);
            color: var(--m3-on-secondary-container);
            border-radius: 12px; /* Изменено на 12px */
            padding: 12px 24px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }

        /* Контейнер кода Python */
        .python-frame {
            border: 2px solid #0000FF; /* Рамка 2px синяя */
            border-radius: 16px;
            overflow: hidden;
            background: #1e1e1e;
            position: relative;
        }

        /* Стилизация Prism под Apps Script */
        pre[class*="language-"] {
            margin: 0 !important;
            background: #1e1e1e !important;
            font-size: 13px !important;
        }

        /* ID задачи в синем блоке */
        .id-badge {
            background-color: #0000FF;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        /* Нижнее расположение кнопок */
        .bottom-action-container {
            position: fixed;
            bottom: 16px; /* Минимальный отступ снизу */
            left: 16px;
            right: 16px;
            z-index: 50;
        }

        .spinner { width: 48px; height: 48px; animation: rotate 2s linear infinite; transform-origin: center center; display: block; }
        .path { stroke: #0000FF; stroke-linecap: round; stroke-width: 4; stroke-dasharray: 1, 150; animation: dash 1.5s ease-in-out infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash { 0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; } 50% { stroke-dasharray: 70, 150; stroke-dashoffset: -25px; } 100% { stroke-dasharray: 70, 150; stroke-dashoffset: -125px; } }

        .page { position: fixed; inset: 0; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s; background: var(--m3-surface); z-index: 10; overflow-y: auto; }
        .page-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .page-active { transform: translateX(0); opacity: 1; z-index: 20; }
        
        .sticky-header { position: sticky; top: 0; height: 64px; background-color: var(--m3-surface); display: flex; align-items: center; padding: 0 16px; z-index: 100; border-bottom: 1px solid rgba(230, 225, 229, 0.1); }
        .m3-card { background-color: var(--m3-surface-container); border-radius: 12px; padding: 16px; border: 1px solid transparent; cursor: pointer; }
        
        .m3-chip { border-radius: 8px; padding: 6px 12px; font-weight: 500; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 6px; }
        .timer-default { background-color: var(--m3-tertiary-container); color: var(--m3-on-tertiary-container); }
        .timer-warning { background-color: var(--m3-warning-container); color: var(--m3-on-warning-container); }
        .timer-error { background-color: var(--m3-on-error); color: var(--m3-error); }

        .m3-textfield { position: relative; width: 100%; margin-bottom: 24px; }
        .m3-textfield input { width: 100%; background: transparent; border: 1px solid var(--md-sys-color-outline); border-radius: 12px; padding: 16px; color: white; outline: none; }
        .m3-textfield label { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: var(--m3-surface-container); padding: 0 4px; color: #999; pointer-events: none; transition: 0.2s; }
        .m3-textfield input:focus + label, .m3-textfield input:not(:placeholder-shown) + label { top: 0; font-size: 12px; color: var(--m3-primary); }

        .notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: calc(100% - 32px); max-width: 400px; padding: 14px 16px; border-radius: 12px; display: flex; align-items: center; gap: 12px; z-index: 2000; transition: top 0.4s; }
        .notification.show { top: 16px; }
        .notification-error { background-color: #920003; color: white; }
        .notification-complete { background-color: #D0BCFF; color: #381E72; }
    </style>
</head>
<body>

    <div id="page-list" class="page page-active">
        <header class="sticky-header">
            <h1 class="text-[16px] font-bold absolute left-1/2 -translate-x-1/2">Разработка</h1>
        </header>
        <div class="max-w-md mx-auto p-4 pb-32">
            <div id="active-tasks-wrapper" class="hidden mb-6">
                <h2 id="active-tasks-header" class="text-xs font-bold uppercase tracking-widest text-blue-400 mb-3 opacity-90 pl-1"></h2>
                <div id="active-tasks-container" class="space-y-3"></div>
            </div>
            <div id="task-counter-container" class="mb-4 hidden">
                <h2 id="task-counter" class="text-xl font-bold text-[#E6E1E5]">Ожидают 0</h2>
            </div>
            <div id="tasks-container" class="space-y-3"></div>
        </div>
    </div>

    <div id="page-assembly" class="page page-hidden">
        <header class="sticky-header justify-between">
            <button onclick="closeAssembly()" class="p-2 -ml-2 rounded-full"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h1 class="text-[16px] font-bold">Выполнение разработки</h1>
            <div id="assembly-timer" class="m3-chip timer-default">
                <i data-lucide="timer" class="w-3.5 h-3.5"></i>
                <span id="assembly-timer-text">--:--</span>
            </div>
        </header>

        <div class="p-6 flex flex-col max-w-xl mx-auto w-full gap-4 pb-40">
            <div class="flex justify-between items-center w-full mb-2">
                <div id="header-task-id-box" class="id-badge">ID: <span id="header-task-id" class="ml-1">----</span></div>
                </div>

            <div id="stage-coding" class="w-full space-y-4">
                <div id="interactive-area" class="opacity-40 pointer-events-none transition-opacity duration-300 w-full">
                    <div class="python-frame">
                        <div id="python-loading-spinner" class="p-10 flex items-center justify-center">
                            <svg class="spinner" viewBox="25 25 50 50"><circle class="path" cx="50" cy="50" r="20" fill="none"/></svg>
                        </div>
                        <pre id="python-pre" class="hidden"><code id="python-code-block" class="language-python"></code></pre>
                        <button onclick="copyCode()" class="absolute top-2 right-2 p-2 bg-black/50 rounded-lg text-blue-400">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                
                <div id="action-area" class="hidden">
                     <button id="secondary-btn" onclick="openAuthSheet()" class="m3-button-tonal w-full visible mb-4">Return of block input</button>
                     <button id="return-code-btn" disabled onclick="handleReturnClick()" class="m3-button !bg-gray-700">Вернуть входной код</button>
                </div>
            </div>

            <div id="stage-final" class="w-full hidden space-y-6">
                 <div class="python-frame p-4 bg-[#1e1e1e]">
                    <pre class="text-[13px] text-purple-300 font-['Fira_Code']">
# Finalizing task bridge...
def push_to_main_stream(blocks):
    return True
blocks_data = [<span id="final-code-entry" class="text-white font-bold">"..."</span>]</pre>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="m3-textfield"><input type="text" id="final-block-1" placeholder=" " oninput="updateFinalCode()"><label>Block ID 1</label></div>
                    <div class="m3-textfield"><input type="text" id="final-block-2" placeholder=" " oninput="updateFinalCode()"><label>Block ID 2</label></div>
                </div>
            </div>
        </div>

        <div class="bottom-action-container">
            <div id="start-overlay">
                <button id="btn-start-assembly" onclick="startAssembly()" class="m3-button shadow-2xl">
                    <i data-lucide="play" class="w-5 h-5 fill-current"></i> Начать выполнение
                </button>
            </div>
            <button id="finish-task-btn" onclick="finalizeTaskProcess()" class="m3-button hidden shadow-lg">
                <i data-lucide="check-circle" class="w-5 h-5"></i> Завершить выполнение
            </button>
        </div>
    </div>

    <div id="scrim-main" class="fixed inset-0 bg-black/60 opacity-0 invisible transition-all z-[1000]" onclick="closeAllSheets()"></div>
    <div id="sheet-auth" class="fixed bottom-0 left-0 right-0 bg-[#161c24] rounded-t-[28px] p-6 translate-y-full transition-transform z-[1001] max-w-md mx-auto">
        <h3 class="text-xl mb-6 text-center">Токен блока Python</h3>
        <div class="m3-textfield"><input type="text" id="token-input" placeholder=" "><label>Аутентификационный токен</label></div>
        <button onclick="authorizeCode()" class="m3-button">Авторизовать</button>
    </div>

    <div id="notif-error" class="notification notification-error"><span class="text-sm font-bold">Функция «Return» заблокирована</span></div>
    <div id="notif-complete" class="notification notification-complete"><span class="text-sm font-bold">Выполнение завершено</span></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYIThLvfF1N6s2PhzvqvI5Q7YP_XWARDGVF80sjDyjAbUX34WeSazYBooafEBN2--Y/exec';
        let activeTaskId = null;
        let poolTasks = [];
        let userActiveTasks = [];

        // Инициализация
        function initAppLogic() {
            lucide.createIcons();
            setInterval(tickTimers, 1000);
            setInterval(refreshData, 3000);
            refreshData();
        }

        async function refreshData() {
            const email = localStorage.getItem('userEmail');
            if(!email) return;
            try {
                const [pRes, aRes] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getTasks`).then(r => r.json()),
                    fetch(`${SCRIPT_URL}?action=getUserActiveTasks&email=${encodeURIComponent(email)}`).then(r => r.json())
                ]);
                renderTasks(pRes, false);
                renderTasks(aRes, true);
            } catch (e) { console.error(e); }
        }

        function renderTasks(tasks, isActive) {
            const container = isActive ? document.getElementById('active-tasks-container') : document.getElementById('tasks-container');
            if(isActive) document.getElementById('active-tasks-wrapper').classList.toggle('hidden', tasks.length === 0);
            
            container.innerHTML = '';
            tasks.forEach(t => {
                const card = document.createElement('div');
                card.className = `m3-card ${isActive ? 'border-[#0000FF]' : ''}`;
                card.onclick = () => isActive ? restoreSession(t.id, t.stage) : openAssembly(t.id);
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-[10px] uppercase text-blue-400 font-bold">${isActive ? 'В работе' : 'Задача'}</div>
                            <div class="text-sm font-mono">${t.id}</div>
                        </div>
                        <div class="m3-chip timer-default text-[12px]">${formatTime(t.durationSeconds)}</div>
                    </div>`;
                container.appendChild(card);
            });
            if(!isActive) document.getElementById('task-counter').textContent = `Ожидают ${tasks.length}`;
            if(!isActive) document.getElementById('task-counter-container').classList.remove('hidden');
        }

        function openAssembly(id) {
            activeTaskId = id;
            document.getElementById('header-task-id').textContent = id;
            document.getElementById('page-list').classList.add('opacity-0');
            document.getElementById('page-assembly').classList.remove('page-hidden');
            document.getElementById('page-assembly').classList.add('page-active');
            
            // Сброс состояния
            document.getElementById('start-overlay').classList.remove('hidden');
            document.getElementById('finish-task-btn').classList.add('hidden');
            document.getElementById('interactive-area').style.opacity = '0.4';
            document.getElementById('action-area').classList.add('hidden');
            lucide.createIcons();
        }

        async function startAssembly() {
            const btn = document.getElementById('btn-start-assembly');
            btn.disabled = true;
            btn.innerHTML = `<svg class="spinner w-5 h-5 mx-auto" viewBox="25 25 50 50"><circle class="path" cx="50" cy="50" r="20" fill="none" stroke="#fff"/></svg>`;
            
            const email = localStorage.getItem('userEmail');
            try {
                // Загрузка кода
                const codeRes = await fetch(`${SCRIPT_URL}?action=getPythonCode`).then(r => r.json());
                const codeEl = document.getElementById('python-code-block');
                codeEl.textContent = codeRes.code;
                Prism.highlightElement(codeEl);
                document.getElementById('python-loading-spinner').classList.add('hidden');
                document.getElementById('python-pre').classList.remove('hidden');

                await fetch(`${SCRIPT_URL}?action=startTask&email=${encodeURIComponent(email)}&taskId=${encodeURIComponent(activeTaskId)}`);
                
                document.getElementById('start-overlay').classList.add('hidden');
                document.getElementById('interactive-area').style.opacity = '1';
                document.getElementById('interactive-area').style.pointerEvents = 'auto';
                document.getElementById('action-area').classList.remove('hidden');
            } catch (e) { alert("Ошибка старта"); btn.disabled = false; }
        }

        function updateFinalCode() {
            const b1 = document.getElementById('final-block-1').value || '...';
            const b2 = document.getElementById('final-block-2').value || '...';
            document.getElementById('final-code-entry').textContent = `"${b1}", "${b2}"`;
        }

        function openAuthSheet() {
            document.getElementById('scrim-main').classList.add('opacity-100', 'visible');
            document.getElementById('sheet-auth').classList.remove('translate-y-full');
        }

        function authorizeCode() {
            closeAllSheets();
            document.getElementById('stage-coding').classList.add('hidden');
            document.getElementById('stage-final').classList.remove('hidden');
            document.getElementById('finish-task-btn').classList.remove('hidden');
        }

        async function finalizeTaskProcess() {
            const btn = document.getElementById('finish-task-btn');
            btn.disabled = true;
            const email = localStorage.getItem('userEmail');
            try {
                await fetch(`${SCRIPT_URL}?action=completeTask&email=${encodeURIComponent(email)}&taskId=${encodeURIComponent(activeTaskId)}`);
                document.getElementById('notif-complete').classList.add('show');
                setTimeout(() => location.reload(), 1500);
            } catch (e) { btn.disabled = false; }
        }

        function closeAssembly() {
            document.getElementById('page-assembly').classList.add('page-hidden');
            document.getElementById('page-list').classList.remove('opacity-0');
        }

        function closeAllSheets() {
            document.getElementById('scrim-main').classList.remove('opacity-100', 'visible');
            document.getElementById('sheet-auth').classList.add('translate-y-full');
        }

        function formatTime(s) {
            const m = Math.floor(Math.abs(s)/60);
            const sec = Math.abs(s)%60;
            return `${s<0?'+':''}${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }

        function tickTimers() { /* Логика тика секунд */ }

        window.onload = () => {
            if(!localStorage.getItem('userEmail')) {
                window.location.href = "https://u8902054545-design.github.io/Auth-ITC-Platform/";
            } else {
                const loader = document.createElement('div');
                loader.className = "fixed inset-0 bg-[#0b1219] z-[9999] flex items-center justify-center";
                loader.innerHTML = '<svg class="spinner" viewBox="25 25 50 50"><circle class="path" cx="50" cy="50" r="20" fill="none"/></svg>';
                document.body.appendChild(loader);
                setTimeout(() => { loader.remove(); initAppLogic(); }, 1000);
            }
        };
    </script>
</body>
</html>
